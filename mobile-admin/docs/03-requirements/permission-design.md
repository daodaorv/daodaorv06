# ç§»åŠ¨ç®¡ç†ç«¯æƒé™è®¾è®¡æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0 | **åˆ›å»ºæ—¶é—´**: 2025-11-24 | **æ›´æ–°æ—¶é—´**: 2025-11-24 | **ç»´æŠ¤è€…**: å¨å¨æˆ¿è½¦æŠ€æœ¯å›¢é˜Ÿ

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†å¨å¨æˆ¿è½¦ç§»åŠ¨ç®¡ç†ç«¯çš„æƒé™ä½“ç³»è®¾è®¡ï¼ŒåŒ…æ‹¬è§’è‰²å®šä¹‰ã€æƒé™åˆ†é…ã€å®‰å…¨æ§åˆ¶æœºåˆ¶ç­‰ã€‚

### æƒé™è®¾è®¡åŸåˆ™

1. **æœ€å°æƒé™åŸåˆ™**: ç”¨æˆ·åªèƒ½è®¿é—®å¿…éœ€çš„åŠŸèƒ½å’Œæ•°æ®
2. **è§’è‰²åˆ†ç¦»åŸåˆ™**: ä¸åŒè§’è‰²å…·æœ‰æ˜ç¡®çš„æƒé™è¾¹ç•Œ
3. **åŠ¨æ€æƒé™æ§åˆ¶**: æ”¯æŒè¿è¡Œæ—¶æƒé™è°ƒæ•´å’ŒéªŒè¯
4. **å®‰å…¨å®¡è®¡åŸåˆ™**: æ‰€æœ‰æƒé™æ“ä½œéƒ½éœ€è¦è®°å½•å’Œå®¡è®¡

---

## ğŸ‘¥ è§’è‰²å®šä¹‰

### è§’è‰²å±‚æ¬¡ç»“æ„

```
è¶…çº§ç®¡ç†å‘˜ (L5)
â”œâ”€â”€ åŒºåŸŸç»ç† (L4)
â”‚   â”œâ”€â”€ é—¨åº—ç»ç† (L3)
â”‚   â”‚   â”œâ”€â”€ ç°åœºç®¡ç†å‘˜ (L2)
â”‚   â”‚   â””â”€â”€ å®¢æœäººå‘˜ (L1)
```

### è§’è‰²è¯¦ç»†å®šä¹‰

#### L5 - è¶…çº§ç®¡ç†å‘˜
- **èŒè´£**: ç³»ç»Ÿå…¨å±€ç®¡ç†
- **æƒé™èŒƒå›´**: æ‰€æœ‰åŠŸèƒ½å’Œæ•°æ®
- **ç‰¹æ®Šæƒé™**: ç³»ç»Ÿé…ç½®ã€ç”¨æˆ·è§’è‰²ç®¡ç†
- **æ•°æ®èŒƒå›´**: å…¨å¹³å°æ•°æ®

#### L4 - åŒºåŸŸç»ç†
- **èŒè´£**: åŒºåŸŸä¸šåŠ¡ç®¡ç†
- **æƒé™èŒƒå›´**: åŒºåŸŸå†…æ‰€æœ‰ä¸šåŠ¡åŠŸèƒ½
- **ç‰¹æ®Šæƒé™**: åŒºåŸŸæ•°æ®æŸ¥çœ‹ã€åŒºåŸŸå†…ç”¨æˆ·ç®¡ç†
- **æ•°æ®èŒƒå›´**: æŒ‡å®šåŒºåŸŸæ•°æ®

#### L3 - é—¨åº—ç»ç†
- **èŒè´£**: é—¨åº—ä¸šåŠ¡ç®¡ç†
- **æƒé™èŒƒå›´**: é—¨åº—å†…ä¸šåŠ¡æ“ä½œå’Œç®¡ç†
- **ç‰¹æ®Šæƒé™**: é—¨åº—é…ç½®ã€é—¨åº—ç”¨æˆ·ç®¡ç†
- **æ•°æ®èŒƒå›´**: æŒ‡å®šé—¨åº—æ•°æ®

#### L2 - ç°åœºç®¡ç†å‘˜
- **èŒè´£**: ç°åœºä¸šåŠ¡å¤„ç†
- **æƒé™èŒƒå›´**: è®¢å•å¤„ç†ã€è½¦è¾†çŠ¶æ€ç®¡ç†
- **ç‰¹æ®Šæƒé™**: æ— 
- **æ•°æ®èŒƒå›´**: å½“å‰å¤„ç†çš„ä¸šåŠ¡æ•°æ®

#### L1 - å®¢æœäººå‘˜
- **èŒè´£**: å®¢æˆ·æœåŠ¡æ”¯æŒ
- **æƒé™èŒƒå›´**: ç”¨æˆ·ä¿¡æ¯æŸ¥çœ‹ã€å®¢æˆ·æœåŠ¡
- **ç‰¹æ®Šæƒï¿½ï¿½ï¿½**: æ— 
- **æ•°æ®èŒƒå›´**: å®¢æˆ·ç›¸å…³æ•°æ®

---

## ğŸ” æƒé™ä½“ç³»è®¾è®¡

### æƒé™åˆ†ç±»

#### 1. åŠŸèƒ½æƒé™ (Function Permissions)

| æ¨¡å— | æƒé™ä»£ç  | æƒé™æè¿° | L5 | L4 | L3 | L2 | L1 |
|------|----------|----------|----|----|----|----|----|
| **é¦–é¡µ** | dashboard_view | æŸ¥çœ‹æ•°æ®æ¦‚è§ˆ | âœ… | âœ… | âœ… | âœ… | âœ… |
| **ç”¨æˆ·ç®¡ç†** | user_list | æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ | âœ… | âŒ | âŒ | âŒ | âŒ |
| | user_detail | æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| | user_create | åˆ›å»ºç”¨æˆ· | âœ… | âŒ | âŒ | âŒ | âŒ |
| | user_update | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ | âœ… | âœ… | âœ… | âŒ | âŒ |
| | user_delete | åˆ é™¤ç”¨æˆ· | âœ… | âŒ | âŒ | âŒ | âŒ |
| **è®¢å•ç®¡ç†** | order_list | æŸ¥çœ‹è®¢å•åˆ—è¡¨ | âœ… | âœ… | âœ… | âœ… | âœ… |
| | order_detail | æŸ¥çœ‹è®¢å•è¯¦æƒ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| | order_create | åˆ›å»ºè®¢å• | âœ… | âœ… | âœ… | âœ… | âŒ |
| | order_update | æ›´æ–°è®¢å• | âœ… | âœ… | âœ… | âœ… | âŒ |
| | order_delete | åˆ é™¤è®¢å• | âœ… | âœ… | âŒ | âŒ | âŒ |
| | order_cancel | å–æ¶ˆè®¢å• | âœ… | âœ… | âœ… | âœ… | âŒ |
| **è½¦è¾†ç®¡ç†** | vehicle_list | æŸ¥çœ‹è½¦è¾†åˆ—è¡¨ | âœ… | âœ… | âœ… | âœ… | âœ… |
| | vehicle_detail | æŸ¥çœ‹è½¦è¾†è¯¦æƒ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| | vehicle_create | åˆ›å»ºè½¦è¾† | âœ… | âŒ | âœ… | âœ… | âŒ |
| | vehicle_update | æ›´æ–°è½¦è¾† | âœ… | âœ… | âœ… | âœ… | âŒ |
| | vehicle_delete | åˆ é™¤è½¦è¾† | âœ… | âŒ | âŒ | âŒ | âŒ |
| | vehicle_status | æ›´æ–°è½¦è¾†çŠ¶æ€ | âœ… | âœ… | âœ… | âœ… | âŒ |
| **è´¢åŠ¡ç®¡ç†** | finance_view | æŸ¥çœ‹è´¢åŠ¡æ•°æ® | âœ… | âœ… | âŒ | âŒ | âŒ |
| | finance_export | å¯¼å‡ºè´¢åŠ¡æŠ¥è¡¨ | âœ… | âœ… | âŒ | âŒ | âŒ |
| **ç³»ç»Ÿè®¾ç½®** | system_config | ç³»ç»Ÿé…ç½® | âœ… | âŒ | âŒ | âŒ | âŒ |
| | system_logs | æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿— | âœ… | âŒ | âŒ | âŒ | âŒ |

#### 2. æ•°æ®æƒé™ (Data Permissions)

| æ•°æ®èŒƒå›´ | æƒé™ä»£ç  | æè¿° | é€‚ç”¨è§’è‰² |
|----------|----------|------|----------|
| **å…¨å±€æ•°æ®** | data_global | æ‰€æœ‰æ•°æ® | è¶…çº§ç®¡ç†å‘˜ |
| **åŒºåŸŸæ•°æ®** | data_region | æŒ‡å®šåŒºåŸŸæ•°æ® | åŒºåŸŸç»ç† |
| **é—¨åº—æ•°æ®** | data_store | æŒ‡å®šé—¨åº—æ•°æ® | é—¨åº—ç»ç† |
| **ä¸ªäººæ•°æ®** | data_personal | ä¸ªäººå¤„ç†æ•°æ® | ç°åœºç®¡ç†å‘˜ã€å®¢æœäººå‘˜ |
| **å®¢æˆ·æ•°æ®** | data_customer | å®¢æˆ·ç›¸å…³æ•°æ® | å®¢æœäººå‘˜ |

#### 3. æ“ä½œæƒé™ (Operation Permissions)

| æ“ä½œç±»å‹ | æƒé™ä»£ç  | æè¿° | å®‰å…¨çº§åˆ« |
|----------|----------|------|----------|
| **æŸ¥çœ‹** | op_read | æŸ¥çœ‹æ“ä½œ | ä½ |
| **åˆ›å»º** | op_create | åˆ›å»ºæ“ä½œ | ä¸­ |
| **æ›´æ–°** | op_update | æ›´æ–°æ“ä½œ | ä¸­ |
| **åˆ é™¤** | op_delete | åˆ é™¤æ“ä½œ | é«˜ |
| **å¯¼å‡º** | op_export | æ•°æ®å¯¼å‡º | é«˜ |
| **é…ç½®** | op_config | ç³»ç»Ÿé…ç½® | é«˜ |

---

## ğŸ›¡ï¸ å®‰å…¨æ§åˆ¶æœºåˆ¶

### 1. è®¤è¯æœºåˆ¶

#### JWT Token è®¤è¯
```javascript
// Token ç»“æ„
{
  "userId": 123,
  "roleId": 3,
  "permissions": ["order_list", "order_update"],
  "dataScope": "store_001",
  "exp": 1701234567,
  "iat": 1701154567
}
```

#### ç™»å½•å®‰å…¨
- æ‰‹æœºå· + å¯†ç è®¤è¯
- è®¾å¤‡æŒ‡çº¹è¯†åˆ«
- å¼‚åœ°ç™»å½•æ£€æµ‹
- ç™»å½•å¤±è´¥é™åˆ¶

### 2. æƒé™éªŒè¯æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·æ“ä½œ] --> B{æ£€æŸ¥ç™»å½•çŠ¶æ€}
    B -->|æœªç™»å½•| C[è·³è½¬ç™»å½•é¡µ]
    B -->|å·²ç™»å½•| D{è§£æTokenæƒé™}
    D --> E{éªŒè¯åŠŸèƒ½æƒé™}
    E -->|æ— æƒé™| F[æ˜¾ç¤ºæƒé™ä¸è¶³]
    E -->|æœ‰æƒé™| G{éªŒè¯æ•°æ®æƒé™}
    G -->|æ— æ•°æ®æƒé™| H[è¿‡æ»¤æ•°æ®ç»“æœ}
    G -->|æœ‰æ•°æ®æƒé™| I{éªŒè¯æ“ä½œæƒé™}
    I -->|æ— æ“ä½œæƒé™| J[éšè—æ“ä½œæŒ‰é’®}
    I -->|æœ‰æ“ä½œæƒé™| K[æ‰§è¡Œæ“ä½œ]
    K --> L[è®°å½•æ“ä½œæ—¥å¿—]
```

### 3. æƒé™æ£€æŸ¥å®ç°

#### å‰ç«¯æƒé™æ£€æŸ¥
```javascript
// æƒé™æ£€æŸ¥å·¥å…·å‡½æ•°
export const hasPermission = (permission) => {
  const userInfo = uni.getStorageSync('mobile_admin_userInfo');
  return userInfo?.permissions?.includes(permission) || false;
};

// æ•°æ®æƒé™è¿‡æ»¤
export const filterDataByScope = (data, userScope) => {
  switch (userScope) {
    case 'global':
      return data;
    case 'region':
      return data.filter(item => item.regionId === userInfo.regionId);
    case 'store':
      return data.filter(item => item.storeId === userInfo.storeId);
    default:
      return data.filter(item => item.createdBy === userInfo.id);
  }
};
```

#### åç«¯æƒé™éªŒè¯
```typescript
// ä¸­é—´ä»¶æƒé™éªŒè¯
const checkPermission = (requiredPermissions: string[]) => {
  return (req: Request, res: Response, next: NextFunction) => {
    const userPermissions = req.user.permissions;
    const hasPermission = requiredPermissions.every(
      permission => userPermissions.includes(permission)
    );

    if (!hasPermission) {
      return res.status(403).json({
        code: 403001,
        message: 'æƒé™ä¸è¶³',
        data: null
      });
    }

    next();
  };
};
```

---

## ğŸ”’ å®‰å…¨ç­–ç•¥

### 1. æ•æ„Ÿæ“ä½œä¿æŠ¤

#### äºŒæ¬¡ç¡®è®¤æœºåˆ¶
- åˆ é™¤æ“ä½œéœ€è¦äºŒæ¬¡ç¡®è®¤
- æ‰¹é‡æ“ä½œéœ€è¦ç¡®è®¤
- é‡è¦é…ç½®ä¿®æ”¹éœ€è¦éªŒè¯

#### æ“ä½œé¢‘ç‡é™åˆ¶
```javascript
// é¢‘ç‡é™åˆ¶é…ç½®
const RATE_LIMITS = {
  'login': { count: 5, window: 300000 },      // 5åˆ†é’Ÿå†…æœ€å¤š5æ¬¡ç™»å½•
  'order_update': { count: 20, window: 60000 }, // 1åˆ†é’Ÿå†…æœ€å¤š20æ¬¡è®¢å•æ›´æ–°
  'data_export': { count: 3, window: 3600000 }  // 1å°æ—¶å†…æœ€å¤š3æ¬¡å¯¼å‡º
};
```

### 2. æ•°æ®å®‰å…¨

#### æ•æ„Ÿæ•°æ®è„±æ•
```javascript
// æ•°æ®è„±æ•è§„åˆ™
const MASK_RULES = {
  phone: (phone) => phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2'),
  idCard: (idCard) => idCard.replace(/(\d{6})\d{8}(\d{4})/, '$1********$2'),
  email: (email) => email.replace(/(.{2}).*(@.*)/, '$1****$2')
};
```

#### æ•°æ®ä¼ è¾“åŠ å¯†
- HTTPS ä¼ è¾“åŠ å¯†
- API æ•°æ®ç­¾åéªŒè¯
- æ•æ„Ÿæ•°æ®å­—æ®µåŠ å¯†

### 3. å®¡è®¡æ—¥å¿—

#### æ“ä½œæ—¥å¿—è®°å½•
```javascript
// æ“ä½œæ—¥å¿—ç»“æ„
const operationLog = {
  userId: 123,
  userName: 'å¼ ä¸‰',
  action: 'order_update',
  module: 'è®¢å•ç®¡ç†',
  resourceId: 'ORDER_001',
  details: {
    before: { status: 'pending' },
    after: { status: 'confirmed' }
  },
  ip: '192.168.1.100',
  userAgent: 'Mobile Admin v1.0.0',
  timestamp: '2025-11-24T10:30:00Z',
  result: 'success'
};
```

#### å®¡è®¡æŠ¥å‘Š
- æ¯æ—¥æ“ä½œç»Ÿè®¡æŠ¥å‘Š
- å¼‚å¸¸æ“ä½œæŠ¥è­¦
- æƒé™å˜æ›´è®°å½•
- å®‰å…¨äº‹ä»¶è¿½è¸ª

---

## ğŸ“± ç§»åŠ¨ç«¯æƒé™ç‰¹æ€§

### 1. ç”Ÿç‰©è¯†åˆ«é›†æˆ

```javascript
// ç”Ÿç‰©è¯†åˆ«è®¤è¯
export const biometricAuth = async () => {
  try {
    // æ£€æŸ¥ç”Ÿç‰©è¯†åˆ«å¯ç”¨æ€§
    const isAvailable = await uni.checkBiometricAuth();
    if (!isAvailable) return false;

    // æ‰§è¡Œç”Ÿç‰©è¯†åˆ«
    const result = await uni.startBiometricAuth({
      reason: 'éªŒè¯èº«ä»½ä»¥ç»§ç»­æ“ä½œ'
    });

    return result.success;
  } catch (error) {
    console.error('ç”Ÿç‰©è¯†åˆ«å¤±è´¥:', error);
    return false;
  }
};
```

### 2. è®¾å¤‡å®‰å…¨ç®¡ç†

#### è®¾å¤‡ç»‘å®š
- ç”¨æˆ·è´¦å·ç»‘å®šè®¾å¤‡
- å¼‚å¸¸è®¾å¤‡ç™»å½•æé†’
- è®¾å¤‡è§£ç»‘æµç¨‹

#### åº”ç”¨å®‰å…¨
- åº”ç”¨é”åŠŸèƒ½
- åˆ‡æ¢åå°è‡ªåŠ¨é”å®š
- é˜²æˆªå±ä¿æŠ¤

### 3. ç½‘ç»œå®‰å…¨

#### è¯ä¹¦å›ºå®š
```javascript
// HTTPS è¯ä¹¦å›ºå®š
const SSL_PINNING = {
  'api.daodao-fangche.com': 'sha256/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA='
};
```

#### è¯·æ±‚ç­¾å
```javascript
// API è¯·æ±‚ç­¾å
const signRequest = (data, timestamp, nonce) => {
  const sortedParams = Object.keys(data).sort().map(key => `${key}=${data[key]}`).join('&');
  const signString = `${sortedParams}&timestamp=${timestamp}&nonce=${nonce}`;
  return crypto.createHash('sha256').update(signString).digest('hex');
};
```

---

## ğŸ¯ æƒé™ç®¡ç†æœ€ä½³å®è·µ

### 1. æƒé™è®¾è®¡åŸåˆ™

1. **æƒé™æœ€å°åŒ–**: åªæˆäºˆå¿…è¦çš„æƒé™
2. **èŒè´£åˆ†ç¦»**: é¿å…æƒé™è¿‡äºé›†ä¸­
3. **å®šæœŸå®¡æŸ¥**: å®šæœŸæ£€æŸ¥å’Œè°ƒæ•´æƒé™
4. **æƒé™å›æ”¶**: åŠæ—¶å›æ”¶ç¦»èŒäººå‘˜æƒé™

### 2. å®æ–½å»ºè®®

1. **æƒé™é…ç½®åŒ–**: æ”¯æŒåŠ¨æ€æƒé™é…ç½®
2. **æƒé™å¯è§†åŒ–**: æä¾›æƒé™ç®¡ç†ç•Œé¢
3. **æƒé™æµ‹è¯•**: å®Œå–„çš„æƒé™æµ‹è¯•ç”¨ä¾‹
4. **æƒé™æ–‡æ¡£**: è¯¦ç»†çš„æƒé™è¯´æ˜æ–‡æ¡£

### 3. ç›‘æ§å’ŒæŠ¥è­¦

1. **å¼‚å¸¸æƒé™è®¿é—®**: ç›‘æ§å¼‚å¸¸æƒé™è®¿é—®è¡Œä¸º
2. **æƒé™å˜æ›´æŠ¥è­¦**: é‡è¦æƒé™å˜æ›´å®æ—¶æŠ¥è­¦
3. **å®‰å…¨äº‹ä»¶å“åº”**: å¿«é€Ÿå“åº”å®‰å…¨äº‹ä»¶
4. **å®šæœŸå®‰å…¨å®¡è®¡**: å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡

---

## ğŸ“‹ æƒé™é…ç½®ç¤ºä¾‹

### è§’è‰²æƒé™é…ç½®æ–‡ä»¶

```json
{
  "roles": {
    "store_manager": {
      "name": "é—¨åº—ç»ç†",
      "level": 3,
      "permissions": [
        "dashboard_view",
        "user_detail",
        "user_update",
        "order_list",
        "order_detail",
        "order_create",
        "order_update",
        "order_cancel",
        "vehicle_list",
        "vehicle_detail",
        "vehicle_create",
        "vehicle_update",
        "vehicle_status"
      ],
      "dataScope": "store",
      "specialPermissions": []
    }
  }
}
```

### æƒé™æ£€æŸ¥ä¸­é—´ä»¶é…ç½®

```javascript
// è·¯ç”±æƒé™é…ç½®
const ROUTE_PERMISSIONS = {
  '/pages/users/users': ['user_list'],
  '/pages/orders/orders': ['order_list'],
  '/pages/vehicles/vehicles': ['vehicle_list']
};

// é¡µé¢æƒé™å®ˆå«
export const routeGuard = (url) => {
  const requiredPermissions = ROUTE_PERMISSIONS[url];
  if (requiredPermissions) {
    return requiredPermissions.every(permission => hasPermission(permission));
  }
  return true;
};
```

---

**æ–‡æ¡£ç»´æŠ¤**: å¨å¨æˆ¿è½¦æŠ€æœ¯å›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2025-11-24
**ç‰ˆæœ¬**: v1.0.0