# 登录拦截使用指南

> **文档版本**: v1.0
> **创建时间**: 2025-12-01
> **维护者**: 小程序端开发团队

---

## 📋 概述

本文档介绍如何在叨叨房车小程序中使用登录状态管理和登录拦截功能，确保需要登录的页面和操作能够正确引导用户登录。

---

## 🔧 核心工具

### 工具文件位置
`miniprogram/utils/auth.ts`

### 主要功能

| 函数名 | 功能描述 | 返回值 |
|--------|----------|--------|
| `isLoggedIn()` | 检查是否已登录 | `boolean` |
| `getCurrentUser()` | 获取当前用户信息 | `UserInfo \| null` |
| `getToken()` | 获取Token | `string \| null` |
| `saveLoginInfo()` | 保存登录信息 | `void` |
| `clearLoginInfo()` | 清除登录信息 | `void` |
| `requireLogin()` | 登录拦截（未登录跳转登录页） | `boolean` |
| `showLoginTip()` | 显示登录提示弹窗 | `void` |
| `logout()` | 退出登录 | `Promise<void>` |
| `handleLoginSuccess()` | 登录成功后的跳转处理 | `void` |

---

## 📖 使用场景

### 场景1：页面级登录拦截（推荐）

**适用场景**：整个页面需要登录才能访问（如订单列表、我的收藏等）

**实现方式**：在页面的 `onMounted` 或 `onLoad` 生命周期中调用 `requireLogin()`

```vue
<script setup lang="ts">
import { onMounted } from 'vue'
import { requireLogin } from '@/utils/auth'

onMounted(() => {
  // 检查登录状态，未登录则自动跳转登录页
  if (!requireLogin()) {
    return // 未登录，停止后续操作
  }

  // 已登录，继续加载页面数据
  loadPageData()
})

const loadPageData = () => {
  // 加载页面数据的逻辑
}
</script>
```

**效果**：
- ✅ 未登录用户访问页面时，自动跳转到登录页
- ✅ 登录成功后自动返回原页面
- ✅ 已登录用户正常访问页面

---

### 场景2：操作级登录拦截

**适用场景**：页面可以浏览，但某些操作需要登录（如点赞、收藏、评论等）

**实现方式**：在操作函数中调用 `requireLogin()`

```vue
<script setup lang="ts">
import { requireLogin } from '@/utils/auth'

// 收藏操作
const handleFavorite = (itemId: string) => {
  // 检查登录状态
  if (!requireLogin()) {
    return // 未登录，已自动跳转登录页
  }

  // 已登录，执行收藏操作
  addToFavorites(itemId)
}

// 点赞操作
const handleLike = (postId: string) => {
  if (!requireLogin()) {
    return
  }

  likePost(postId)
}
</script>
```

**效果**：
- ✅ 未登录用户可以浏览内容
- ✅ 点击需要登录的操作时，跳转到登录页
- ✅ 登录成功后返回原页面，可继续操作

---

### 场景3：带提示的登录拦截

**适用场景**：需要向用户说明为什么需要登录

**实现方式**：使用 `showLoginTip()` 显示提示弹窗

```vue
<script setup lang="ts">
import { showLoginTip } from '@/utils/auth'

// 发布内容
const handlePublish = () => {
  showLoginTip('发布内容需要先登录哦~')
}

// 查看联系方式
const handleViewContact = () => {
  showLoginTip('查看联系方式需要登录', '/pages/detail/index?id=123')
}
</script>
```

**效果**：
- ✅ 显示友好的提示弹窗
- ✅ 用户可以选择"去登录"或"取消"
- ✅ 点击"去登录"后跳转到登录页

---

### 场景4：检查登录状态（不跳转）

**适用场景**：只需要判断登录状态，不需要跳转（如显示不同的UI）

**实现方式**：使用 `isLoggedIn()` 判断

```vue
<template>
  <view class="page">
    <!-- 根据登录状态显示不同内容 -->
    <view v-if="isLogin" class="user-info">
      <text>欢迎，{{ userInfo.nickname }}</text>
    </view>
    <view v-else class="login-tip">
      <button @click="goToLogin">点击登录</button>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref, onShow } from 'vue'
import { isLoggedIn, getCurrentUser } from '@/utils/auth'

const isLogin = ref(false)
const userInfo = ref(null)

// 页面显示时检查登录状态
onShow(() => {
  isLogin.value = isLoggedIn()
  if (isLogin.value) {
    userInfo.value = getCurrentUser()
  }
})

const goToLogin = () => {
  uni.navigateTo({
    url: '/pages/auth/login'
  })
}
</script>
```

**效果**：
- ✅ 根据登录状态显示不同UI
- ✅ 不会自动跳转
- ✅ 用户可以主动选择登录

---

### 场景5：登录成功后的处理

**适用场景**：登录页、注册页登录成功后的跳转

**实现方式**：使用 `saveLoginInfo()` 和 `handleLoginSuccess()`

```vue
<script setup lang="ts">
import { saveLoginInfo, handleLoginSuccess } from '@/utils/auth'

// 登录处理
const handleLogin = async () => {
  try {
    // 调用登录API
    const result = await loginApi(formData)

    // 保存登录信息
    saveLoginInfo(result.token, result.refreshToken, result.user)

    uni.showToast({
      title: '登录成功',
      icon: 'success'
    })

    // 延迟跳转（等待Toast显示）
    setTimeout(() => {
      handleLoginSuccess() // 自动处理跳转逻辑
    }, 1500)
  } catch (error) {
    uni.showToast({
      title: error.message || '登录失败',
      icon: 'none'
    })
  }
}
</script>
```

**跳转逻辑**：
1. 如果有 `redirect` 参数，跳转到指定页面
2. 如果有上一页，返回上一页
3. 否则跳转到首页

---

### 场景6：退出登录

**适用场景**：用户主动退出登录

**实现方式**：使用 `logout()` 函数

```vue
<script setup lang="ts">
import { logout } from '@/utils/auth'

// 退出登录
const handleLogout = () => {
  uni.showModal({
    title: '提示',
    content: '确定要退出登录吗？',
    success: async (res) => {
      if (res.confirm) {
        await logout() // 自动清除登录信息并跳转首页
      }
    }
  })
}
</script>
```

**效果**：
- ✅ 清除本地存储的登录信息
- ✅ 调用退出登录API
- ✅ 自动跳转到首页

---

## 🎯 最佳实践

### 1. 页面分类

根据页面特性选择合适的登录拦截方式：

| 页面类型 | 登录要求 | 推荐方式 |
|----------|----------|----------|
| 首页、列表页 | 可浏览 | 不拦截 |
| 详情页 | 可浏览，操作需登录 | 操作级拦截 |
| 订单页、钱包页 | 必须登录 | 页面级拦截 |
| 个人中心 | 必须登录 | 页面级拦截 |

### 2. 用户体验优化

```vue
<script setup lang="ts">
import { requireLogin, showLoginTip } from '@/utils/auth'

// ❌ 不推荐：直接拦截，用户不知道为什么
const handleAction = () => {
  if (!requireLogin()) return
  doSomething()
}

// ✅ 推荐：给出明确提示
const handleAction = () => {
  showLoginTip('该操作需要登录后才能使用')
}
</script>
```

### 3. 登录状态同步

在需要实时反映登录状态的页面（如"我的"页面），使用 `onShow` 生命周期：

```vue
<script setup lang="ts">
import { ref, onShow } from 'vue'
import { isLoggedIn, getCurrentUser } from '@/utils/auth'

const isLogin = ref(false)
const userInfo = ref(null)

// 每次页面显示时都检查登录状态
onShow(() => {
  isLogin.value = isLoggedIn()
  if (isLogin.value) {
    userInfo.value = getCurrentUser()
  }
})
</script>
```

### 4. 错误处理

```vue
<script setup lang="ts">
import { getToken } from '@/utils/auth'

// 在API请求中使用Token
const fetchData = async () => {
  const token = getToken()
  if (!token) {
    uni.showToast({
      title: '请先登录',
      icon: 'none'
    })
    return
  }

  try {
    const result = await api.getData(token)
    // 处理数据
  } catch (error) {
    if (error.code === 401) {
      // Token过期，清除登录信息并跳转登录页
      clearLoginInfo()
      uni.navigateTo({
        url: '/pages/auth/login'
      })
    }
  }
}
</script>
```

---

## 🔍 常见问题

### Q1: 登录后如何返回原页面？

**A**: 使用 `requireLogin()` 会自动保存当前页面路径，登录成功后调用 `handleLoginSuccess()` 会自动返回。

### Q2: 如何在H5环境和小程序环境使用不同的登录方式？

**A**: 登录页面已经自动检测平台，会显示对应的登录方式。开发者无需额外处理。

### Q3: 如何在应用启动时验证Token有效性？

**A**: 在 `App.vue` 的 `onLaunch` 中调用 `checkAndUpdateLoginStatus()`：

```vue
<script setup lang="ts">
import { onLaunch } from '@dcloudio/uni-app'
import { checkAndUpdateLoginStatus } from '@/utils/auth'

onLaunch(() => {
  // 验证Token有效性
  checkAndUpdateLoginStatus()
})
</script>
```

### Q4: 如何处理Token过期？

**A**: 在请求拦截器中统一处理：

```typescript
// utils/request.ts
import { clearLoginInfo } from '@/utils/auth'

// 响应拦截器
if (response.code === 401) {
  // Token过期
  clearLoginInfo()
  uni.showToast({
    title: '登录已过期，请重新登录',
    icon: 'none'
  })
  uni.navigateTo({
    url: '/pages/auth/login'
  })
}
```

---

## 📝 完整示例

### 示例1：订单列表页（完整代码）

```vue
<template>
  <view class="order-list-page">
    <view v-if="loading" class="loading">加载中...</view>
    <view v-else-if="orders.length === 0" class="empty">暂无订单</view>
    <view v-else class="order-list">
      <view v-for="order in orders" :key="order.id" class="order-item">
        <!-- 订单内容 -->
      </view>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { requireLogin } from '@/utils/auth'
import { getOrderList } from '@/api/order'

const loading = ref(false)
const orders = ref([])

onMounted(() => {
  // 页面级登录拦截
  if (!requireLogin()) {
    return
  }

  loadOrders()
})

const loadOrders = async () => {
  try {
    loading.value = true
    const result = await getOrderList()
    orders.value = result.list
  } catch (error) {
    uni.showToast({
      title: error.message || '加载失败',
      icon: 'none'
    })
  } finally {
    loading.value = false
  }
}
</script>
```

### 示例2：社区详情页（可浏览，操作需登录）

```vue
<template>
  <view class="post-detail-page">
    <view class="post-content">
      <!-- 帖子内容 -->
    </view>
    <view class="post-actions">
      <button @click="handleLike">点赞</button>
      <button @click="handleComment">评论</button>
      <button @click="handleShare">分享</button>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { requireLogin, showLoginTip } from '@/utils/auth'

// 点赞（操作级拦截）
const handleLike = () => {
  if (!requireLogin()) {
    return
  }
  // 执行点赞操作
  likePost()
}

// 评论（带提示的拦截）
const handleComment = () => {
  showLoginTip('评论需要先登录哦~')
}

// 分享（不需要登录）
const handleShare = () => {
  uni.share({
    // 分享配置
  })
}
</script>
```

---

## 🚀 总结

1. **页面级拦截**：使用 `requireLogin()` 在 `onMounted` 中调用
2. **操作级拦截**：在操作函数中调用 `requireLogin()` 或 `showLoginTip()`
3. **状态判断**：使用 `isLoggedIn()` 判断登录状态
4. **登录成功**：使用 `saveLoginInfo()` + `handleLoginSuccess()`
5. **退出登录**：使用 `logout()` 函数

遵循这些最佳实践，可以确保应用的登录流程清晰、用户体验良好。

---

**相关文档**：
- [小程序端API文档](./小程序端API.md)
- [小程序端技术栈文档](./小程序端技术栈文档.md)
