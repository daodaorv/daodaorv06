# 叨叨房车后端API实施计划

> **文件版本**: v1.0
> **创建时间**: 2025-11-26
> **预计工期**: 8个工作日
> **维护者**: 后端开发团队

## 📋 实施概述

基于对各端API文档的分析，现有后端API实现需要大规模重构才能满足前端需求。本文档制定了详细的实施计划，确保高效完成API重建工作。

**重建范围**：
- 🔄 **API路径重构**: 统一前缀管理，支持分端访问
- 🔄 **响应格式重构**: 统一响应格式和错误码体系
- 🔄 **权限系统重构**: 分端权限控制和用户类型管理
- 🔄 **新增接口开发**: 各端缺失的58个API接口

---

## 🎯 总体目标

### 第一阶段目标（1-2天）
- ✅ 完成认证系统重构，支持分端登录
- ✅ 建立统一的API响应格式
- ✅ 实现基础的权限控制机制

### 第二阶段目标（3-4天）
- ✅ 完成小程序端35个API接口开发
- ✅ 完成车辆、订单、支付核心业务API

### 第三阶段目标（5-6天）
- ✅ 完成PC管理端25个API接口开发
- ✅ 实现完整的管理功能和权限控制

### 第四阶段目标（7-8天）
- ✅ 完成移动管理端20个API接口开发
- ✅ 实现移动端专用功能（离线同步、扫码等）
- ✅ 全面的测试和文档完善

---

## 📅 详细实施计划

## Day 1: 基础架构重构

### 上午 (4小时): 认证系统重构

**任务1.1: JWT中间件升级** - 2小时
```typescript
// 文件: backend/src/middleware/auth.ts
// 目标: 支持不同用户类型的JWT验证
// 状态: ⏳ 待开始

// 实现要点:
- 支持Access Token (15分钟) + Refresh Token (7天)
- 区分用户类型: CUSTOMER, STORE_MANAGER, SYSTEM_ADMIN
- 支持分端Token管理:小程序, PC管理端, 移动管理端
```

**任务1.2: 用户类型权限系统** - 2小时
```typescript
// 文件: backend/src/services/auth.service.ts
// 目标: 重构认证服务，支持分端登录
// 状态: ⏳ 待开始

// 实现要点:
- 扩展User模型，添加userType和role字段
- 实现分端登录逻辑和权限验证
- 添加登录日志记录
```

### 下午 (4小时): API基础框架

**任务1.3: 统一响应格式中间件** - 2小时
```typescript
// 文件: backend/src/middleware/response.ts
// 目标: 统一所有API的响应格式
// 状态: ⏳ 待开始

// 实现要点:
- 成功响应格式标准化
- 错误响应格式标准化
- 添加requestId和timestamp
```

**任务1.4: 错误处理中间件升级** - 2小时
```typescript
// 文件: backend/src/middleware/errorHandler.ts
// 目标: 实现统一错误码体系
// 状态: ⏳ 待开始

// 实现要点:
- 实现业务错误码映射
- 统一错误日志格式
- 支持开发和生产环境不同响应
```

### 晚上 (2小时): 基础测试

**任务1.5: 基础功能验证** - 2小时
```bash
# 目标: 确保基础架构重构正常工作
# 测试项目:
- JWT Token生成和验证
- 不同用户类型权限控制
- 统一响应格式
- 错误处理机制
```

---

## Day 2: 小程序端核心API (1/2)

### 上午 (4小时): 用户认证模块

**任务2.1: 发送验证码接口** - 1小时
```typescript
// 接口: POST /api/v1/auth/send-code
// 文档: miniprogram/docs/小程序端API.md:28
// 优先级: 🔴 高
// 状态: ⏳ 待开始
```

**任务2.2: 用户注册接口** - 1小时
```typescript
// 接口: POST /api/v1/auth/register
// 文档: miniprogram/docs/小程序端API.md:55
// 优先级: 🔴 高
// 状态: ⏳ 待开始
```

**任务2.3: 用户登录接口** - 1小时
```typescript
// 接口: POST /api/v1/auth/login
// 文档: miniprogram/docs/小程序端API.md:91
// 优先级: 🔴 高
// 状态: ⏳ 待开始
```

**任务2.4: 微信授权登录接口** - 1小时
```typescript
// 接口: POST /api/v1/auth/wechat-login
// 文档: miniprogram/docs/小程序端API.md:108
// 优先级: 🔴 高
// 状态: ⏳ 待开始
```

### 下午 (4小时): 车辆查询模块

**任务2.5: 房车查询接口** - 2小时
```typescript
// 接口: GET /api/v1/vehicles
// 文档: miniprogram/docs/小程序端API.md:191
// 优先级: 🔴 高
// 复杂度: 高（复杂查询条件、分页、排序）
// 状态: ⏳ 待开始

// 实现要点:
- 支持多种查询条件（城市、门店、时间、价格区间等）
- 实现高效的分页和排序
- 集成车辆可用性检查逻辑
```

**任务2.6: 房车详情接口** - 2小时
```typescript
// 接口: GET /api/v1/vehicles/{id}
// 文档: miniprogram/docs/小程序端API.md:248
// 优先级: 🔴 高
// 复杂度: 中（需要关联多个数据表）
// 状态: ⏳ 待开始

// 实现要点:
- 关联车辆基本信息、规格、配置、图片
- 集成用户评价和评分信息
- 添加车辆可用性状态
```

### 晚上 (2小时): 测试和优化

**任务2.7: 核心API测试** - 2小时
```bash
# 测试目标:
- 用户注册登录流程完整性
- 车辆查询接口性能和准确性
- 响应格式符合规范要求
- 错误处理覆盖完整
```

---

## Day 3: 小程序端核心API (2/2)

### 上午 (4小时): 订单管理模块

**任务3.1: 创建订单接口** - 2小时
```typescript
// 接口: POST /api/v1/orders
// 文档: miniprogram/docs/小程序端API.md:375
// 优先级: 🔴 高
// 复杂度: 高（涉及库存、价格计算、业务规则验证）
// 状态: ⏳ 待开始

// 实现要点:
- 复杂的价格计算逻辑（基础费用、保险、服务费）
- 车辆可用性验证和库存锁定
- 优惠券使用和折扣计算
- 订单状态流转逻辑
```

**任务3.2: 订单价格计算接口** - 1小时
```typescript
// 接口: POST /api/v1/orders/calculate-price
// 文档: miniprogram/docs/小程序端API.md:430
// 优先级: 🔴 高
// 状态: ⏳ 待开始
```

**任务3.3: 获取用户订单列表** - 1小时
```typescript
// 接口: GET /api/v1/orders
// 文档: miniprogram/docs/小程序端API.md:465
// 优先级: 🟡 中
// 状态: ⏳ 待开始
```

### 下午 (4小时): 支付模块

**任务3.4: 创建支付订单接口** - 2小时
```typescript
// 接口: POST /api/v1/payments
// 文档: miniprogram/docs/小程序端API.md:554
// 优先级: 🔴 高
// 复杂度: 高（需要集成微信支付、支付宝、钱包支付）
// 状态: ⏳ 待开始

// 实现要点:
- 支持多种支付方式组合（钱包+第三方支付）
- 集成微信支付SDK
- 实现支付状态异步通知处理
- 添加支付安全验证
```

**任务3.5: 支付状态查询接口** - 2小时
```typescript
// 接口: GET /api/v1/payments/{paymentNo}/status
// 文档: miniprogram/docs/小程序端API.md:603
// 优先级: 🔴 高
// 状态: ⏳ 待开始
```

### 晚上 (2小时): 众筹模块基础

**任务3.6: 众筹项目列表接口** - 2小时
```typescript
// 接口: GET /api/v1/crowdfunding/projects
// 文档: miniprogram/docs/小程序端API.md:632
// 优先级: 🟡 中
// 状态: ⏳ 待开始
```

---

## Day 4: 小程序端辅助API

### 上午 (4小时): 完善小程序API

**任务4.1: 众筹项目详情接口** - 1小时
```typescript
// 接口: GET /api/v1/crowdfunding/projects/{id}
// 文档: miniprogram/docs/小程序端API.md:685
// 优先级: 🟡 中
// 状态: ⏳ 待开始
```

**任务4.2: 众筹份额购买接口** - 1小时
```typescript
// 接口: POST /api/v1/crowdfunding/orders
// 文档: miniprogram/docs/小程序端API.md:698
// 优先级: 🟡 中
// 状态: ⏳ 待开始
```

**任务4.3: 优惠券相关接口** - 2小时
```typescript
// 接口: GET /api/v1/coupons/available
// 接口: POST /api/v1/coupons/{id}/claim
// 文档: miniprogram/docs/小程序端API.md:757, 773
// 优先级: 🟢 低
// 状态: ⏳ 待开始
```

### 下午 (4小时): 门店和用户中心

**任务4.4: 门店相关接口** - 1小时
```typescript
// 接口: GET /api/v1/stores/cities
// 接口: GET /api/v1/stores
// 文档: miniprogram/docs/小程序端API.md:788, 799
// 优先级: 🟡 中
// 状态: ⏳ 待开始
```

**任务4.5: 用户中心接口** - 3小时
```typescript
// 接口: PUT /api/v1/users/profile
// 接口: GET /api/v1/users/wallet
// 接口: GET /api/v1/users/crowdfunding/assets
// 文档: miniprogram/docs/小程序端API.md:817, 828, 839
// 优先级: 🟡 中
// 状态: ⏳ 待开始
```

---

## Day 5: PC管理端认证和用户管理

### 上午 (4小时): 管理员认证模块

**任务5.1: 管理员登录接口** - 2小时
```typescript
// 接口: POST /api/v1/admin/auth/login
// 文档: admin-console/docs/PC管理端API.md:48
// 优先级: 🔴 高
// 状态: ⏳ 待开始

// 实现要点:
- 独立的管理员认证逻辑
- 不同的JWT Token发行策略
- 管理员权限和角色信息返回
```

**任务5.2: 获取管理员信息接口** - 1小时
```typescript
// 接口: GET /api/v1/admin/auth/current-user
// 文档: admin-console/docs/PC管理端API.md:91
// 优先级: 🔴 高
// 状态: ⏳ 待开始
```

**任务5.3: 管理员退出登录接口** - 1小时
```typescript
// 接口: POST /api/v1/admin/auth/logout
// 文档: admin-console/docs/PC管理端API.md:104
// 优先级: 🟡 中
// 状态: ⏳ 待开始
```

### 下午 (4小时): 用户管理模块

**任务5.4: 获取用户列表接口** - 2小时
```typescript
// 接口: GET /api/v1/admin/users
// 文档: admin-console/docs/PC管理端API.md:119
// 优先级: 🔴 高
// 复杂度: 高（复杂查询条件、数据权限控制）
// 状态: ⏳ 待开始

// 实现要点:
- 支持多维度用户搜索和筛选
- 实现数据权限控制（按管理员角色过滤）
- 集成用户统计数据
```

**任务5.5: 获取用户详情接口** - 2小时
```typescript
// 接口: GET /api/v1/admin/users/{userId}
// 文档: admin-console/docs/PC管理端API.md:174
// 优先级: 🔴 高
// 复杂度: 中（需要关联用户档案、订单、资产等数据）
// 状态: ⏳ 待开始
```

---

## Day 6: PC管理端业务API

### 上午 (4小时): 车辆和订单管理

**任务6.1: 车辆管理列表接口** - 2小时
```typescript
// 接口: GET /api/v1/admin/vehicles
// 文档: admin-console/docs/PC管理端API.md:267
// 优先级: 🔴 高
// 状态: ⏳ 待开始

// 实现要点:
- 管理端视角的车辆信息展示
- 支持按门店、状态、类型筛选
- 集成车辆统计数据和维保信息
```

**任务6.2: 订单管理列表接口** - 2小时
```typescript
// 接口: GET /api/v1/admin/orders
// 文档: admin-console/docs/PC管理端API.md:451
// 优先级: 🔴 高
// 状态: ⏳ 待开始

// 实现要点:
- 支持复杂条件搜索和筛选
- 集成订单利润计算
- 支持订单状态批量操作
```

### 下午 (4小时): 数据分析和众筹管理

**任务6.3: 工作台数据接口** - 2小时
```typescript
// 接口: GET /api/v1/admin/analytics/dashboard
// 文档: admin-console/docs/PC管理端API.md:692
// 优先级: 🔴 高
// 复杂度: 高（需要大量数据统计和计算）
// 状态: ⏳ 待开始

// 实现要点:
- 实时数据统计计算
- 多维度数据聚合
- 图表数据格式化
- 性能优化（缓存策略）
```

**任务6.4: 众筹项目管理接口** - 2小时
```typescript
// 接口: GET /api/v1/admin/crowdfunding/projects
// 接口: POST /api/v1/admin/crowdfunding/projects/{projectId}/review
// 文档: admin-console/docs/PC管理端API.md:552, 595
// 优先级: 🟡 中
// 状态: ⏳ 待开始
```

---

## Day 7: 移动管理端API

### 上午 (4小时): 移动端认证和工作台

**任务7.1: 移动端登录接口** - 2小时
```typescript
// 接口: POST /api/v1/mobile/auth/login
// 文档: mobile-admin/docs/移动管理端API.md:62
// 优先级: 🔴 高
// 状态: ⏳ 待开始

// 实现要点:
- 设备绑定和验证逻辑
- 移动端专用的JWT Token策略
- 设备信息记录和管理
```

**任务7.2: 工作台数据接口** - 2小时
```typescript
// 接口: GET /api/v1/mobile/dashboard/overview
// 文档: mobile-admin/docs/移动管理端API.md:173
// 优先级: 🔴 高
// 状态: ⏳ 待开始

// 实现要点:
- 移动端优化的数据展示格式
- 实时任务和提醒信息
- 快捷操作入口配置
```

### 下午 (4小时): 移动端业务功能

**任务7.3: 移动端订单管理** - 2小时
```typescript
// 接口: GET /api/v1/mobile/orders
// 接口: GET /api/v1/mobile/orders/{orderNo}
// 文档: mobile-admin/docs/移动管理端API.md:287, 356
// 优先级: 🔴 高
// 状态: ⏳ 待开始

// 实现要点:
- 移动端优化的订单信息展示
- 现场操作友好的检查清单
- 支持照片上传和位置记录
```

**任务7.4: 扫码识别功能** - 2小时
```typescript
// 接口: POST /api/v1/mobile/scan/vehicle
// 接口: POST /api/v1/mobile/scan/order
// 文档: mobile-admin/docs/移动管理端API.md:668, 720
// 优先级: 🟡 中
// 状态: ⏳ 待开始

// 实现要点:
- QR码解析和验证逻辑
- 扫描位置记录和验证
- 快速操作���口生成
```

---

## Day 8: 移动端特色功能和测试

### 上午 (4小时): 离线同步和照片上传

**任务8.1: 离线数据同步接口** - 2小时
```typescript
// 接口: GET /api/v1/mobile/offline/data
// 接口: POST /api/v1/mobile/offline/sync
// 文档: mobile-admin/docs/移动管理端API.md:797, 841
// 优先级: 🟡 中
// 复杂度: 高（增量数据同步、冲突处理）
// 状态: ⏳ 待开始

// 实现要点:
- 增量数据同步算法
- 离线操作冲突处理机制
- 数据压缩和传输优化
```

**任务8.2: 照片上传接口** - 2小时
```typescript
// 接口: POST /api/v1/mobile/orders/{orderNo}/photos
// 文档: mobile-admin/docs/移动管理端API.md:481
// 优先级: 🟡 中
// 复杂度: 中（图片压缩、批量上传、位置信息）
// 状态: ⏳ 待开始

// 实现要点:
- 图片自动压缩和格式转换
- 支持批量上传和进度跟踪
- GPS位置信息记录和验证
```

### 下午 (4小时): 全面测试和文档完善

**任务8.3: 全端API联调测试** - 2小时
```bash
# 测试范围:
- 小程序端35个API接口
- PC管理端25个API接口
- 移动管理端20个API接口
- 跨端权限控制和数据一致性
```

**任务8.4: 文档更新和代码优化** - 2小时
```bash
# 工作内容:
- 更新各端API.md的开发状态
- 补充API使用示例和说明
- 代码性能优化和安全检查
- 部署文档和运维指南
```

---

## 🎯 里程碑和交付物

### 里程碑1 (Day 2): 小程序端核心API完成
**交付物**:
- ✅ 用户认证模块4个接口
- ✅ 车辆查询模块2个接口
- ✅ 基础架构重构完成

### 里程碑2 (Day 3): 小程序端业务API完成
**交付物**:
- ✅ 订单管理模块3个接口
- ✅ 支付模块2个接口
- ✅ 众筹模块基础接口

### 里程碑3 (Day 4): 小程序端API全部完成
**交付物**:
- ✅ 小程序端35个API接口全部完成
- ✅ 基础业务流程打通
- ✅ 前端联调准备就绪

### 里程碑4 (Day 6): PC管理端API完成
**交付物**:
- ✅ PC管理端25个API接口全部完成
- ✅ 管理功能和权限控制完善
- ✅ 数据统计和分析功能

### 里程碑5 (Day 8): 移动管理端API完成
**交付物**:
- ✅ 移动管理端20个API接口全部完成
- ✅ 移动端特色功能实现
- ✅ 全端API联调测试通过

---

## ⚠️ 风险识别和应对

### 技术风险

**风险1: 数据库性能问题**
- **描述**: 复杂查询可能导致性能问题
- **应对**: 提前进行SQL优化，添加适当索引
- **预案**: 实现查询结果缓存机制

**风险2: 第三方服务集成**
- **描述**: 微信支付等第三方服务集成可能遇到问题
- **应对**: 预留充足的集成和测试时间
- **预案**: 实现支付降级和容错机制

### 进度风险

**风险3: 开发进度延期**
- **描述**: 某些复杂接口开发时间超出预期
- **应对**: 每日检查进度，及时调整计划
- **预案**: 优先实现核心功能，次要功能可适当延后

**风险4: 前端联调问题**
- **描述**: 前后端联调可能发现接口设计问题
- **应对**: 提前与前端团队沟通确认接口设计
- **预案**: 预留接口调整和优化的时间

---

## 📊 质量保证措施

### 代码质量
- **代码审查**: 每个API完成后进行代码审查
- **单元测试**: 核心业务逻辑测试覆盖率达到80%
- **集成测试**: 关键业务流程端到端测试
- **性能测试**: API响应时间和并发能力测试

### 安全保障
- **输入验证**: 所有用户输入严格验证和清理
- **权限控制**: 细粒度的权限验证和数据访问控制
- **敏感数据**: 密码等敏感数据加密存储
- **API安全**: 防止SQL注入、XSS等常见攻击

### 文档完整性
- **API文档**: 每个接口都有完整的文档说明
- **使用示例**: 提供清晰的API调用示例
- **错误码说明**: 详细的错误码和处理说明
- **部署指南**: 完整的部署和运维文档

---

**计划制定人**: 后端开发团队
**最后更新**: 2025-11-26
**下次更新**: 每日进度跟踪后更新