# å¨å¨æˆ¿è½¦ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0 | **åˆ›å»ºæ—¶é—´**: 2025-11-24 | **æ›´æ–°æ—¶é—´**: 2025-11-24 | **ç»´æŠ¤è€…**: å¨å¨æˆ¿è½¦æŠ€æœ¯å›¢é˜Ÿ

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°å¨å¨æˆ¿è½¦ç³»ç»Ÿçš„æ•´ä½“æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬æŠ€æœ¯æ¶æ„ã€ä¸šåŠ¡æ¶æ„ã€æ•°æ®æ¶æ„å’Œéƒ¨ç½²æ¶æ„ï¼Œä¸ºç³»ç»Ÿå¼€å‘ã€éƒ¨ç½²å’Œè¿ç»´æä¾›æŒ‡å¯¼ã€‚

**å…³è”æ–‡æ¡£**ï¼š
- [æŠ€æœ¯æ ˆä¸æ¶æ„è®¾è®¡.md](./æŠ€æœ¯æ ˆä¸æ¶æ„è®¾è®¡.md) - æŠ€æœ¯æ ˆè¯¦ç»†è§„èŒƒ
- [æ•°æ®åº“è®¾è®¡.md](../database/æ•°æ®åº“è®¾è®¡.md) - æ•°æ®åº“è¯¦ç»†è®¾è®¡
- [APIè®¾è®¡è§„èŒƒ.md](../api/APIè®¾è®¡è§„èŒƒ.md) - APIæ¥å£è§„èŒƒ

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ€»è§ˆ](#1-ç³»ç»Ÿæ¶æ„æ€»è§ˆ)
2. [æŠ€æœ¯æ¶æ„è®¾è®¡](#2-æŠ€æœ¯æ¶æ„è®¾è®¡)
3. [ä¸šåŠ¡æ¶æ„è®¾è®¡](#3-ä¸šåŠ¡æ¶æ„è®¾è®¡)
4. [æ•°æ®æ¶æ„è®¾è®¡](#4-æ•°æ®æ¶æ„è®¾è®¡)
5. [å®‰å…¨æ¶æ„è®¾è®¡](#5-å®‰å…¨æ¶æ„è®¾è®¡)
6. [éƒ¨ç½²æ¶æ„è®¾è®¡](#6-éƒ¨ç½²æ¶æ„è®¾è®¡)
7. [æ€§èƒ½æ¶æ„è®¾è®¡](#7-æ€§èƒ½æ¶æ„è®¾è®¡)
8. [ç›‘æ§æ¶æ„è®¾è®¡](#8-ç›‘æ§æ¶æ„è®¾è®¡)

---

## 1. ç³»ç»Ÿæ¶æ„æ€»è§ˆ

### 1.1 ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚"
        A[å¾®ä¿¡å°ç¨‹åº<br/>Cç«¯ç”¨æˆ·]
        B[PCç®¡ç†åå°<br/>Bç«¯ç®¡ç†å‘˜]
        C[ç§»åŠ¨ç®¡ç†ç«¯<br/>ç°åœºå·¥ä½œäººå‘˜]
    end

    subgraph "APIç½‘å…³å±‚"
        D[Nginxè´Ÿè½½å‡è¡¡]
        E[APIç½‘å…³]
    end

    subgraph "åº”ç”¨æœåŠ¡å±‚"
        F[Node.jsåç«¯API<br/>Express.js]
        G[è®¤è¯æœåŠ¡]
        H[ä¸šåŠ¡æœåŠ¡]
        I[æ–‡ä»¶æœåŠ¡]
    end

    subgraph "æ•°æ®å­˜å‚¨å±‚"
        J[MySQLä¸»åº“]
        K[MySQLä»åº“]
        L[Redisç¼“å­˜]
        M[æ–‡ä»¶å­˜å‚¨OSS]
    end

    subgraph "åŸºç¡€è®¾æ–½å±‚"
        N[Dockerå®¹å™¨]
        O[ç›‘æ§å‘Šè­¦]
        P[æ—¥å¿—æ”¶é›†]
    end

    A --> D
    B --> D
    C --> D
    D --> E
    E --> F
    F --> G
    F --> H
    F --> I
    G --> J
    H --> J
    I --> M
    F --> L
    J --> K

    F --> N
    N --> O
    N --> P
```

### 1.2 æ ¸å¿ƒè®¾è®¡åŸåˆ™

**é«˜å¯ç”¨æ€§åŸåˆ™**
- æœåŠ¡æ— å•ç‚¹æ•…éšœ
- æ•°æ®åº“ä¸»ä»å¤åˆ¶
- Redisé›†ç¾¤éƒ¨ç½²
- è‡ªåŠ¨æ•…éšœè½¬ç§»

**å¯æ‰©å±•æ€§åŸåˆ™**
- å¾®æœåŠ¡æ¶æ„è®¾è®¡
- æ°´å¹³æ‰©å±•èƒ½åŠ›
- æ¨¡å—åŒ–å¼€å‘
- æ’ä»¶åŒ–åŠŸèƒ½

**å®‰å…¨æ€§åŸåˆ™**
- å¤šå±‚å®‰å…¨é˜²æŠ¤
- æ•°æ®åŠ å¯†ä¼ è¾“
- æƒé™ç²¾ç»†åŒ–æ§åˆ¶
- å®‰å…¨å®¡è®¡æ—¥å¿—

**æ€§èƒ½ä¼˜åŒ–åŸåˆ™**
- ç¼“å­˜ç­–ç•¥ä¼˜åŒ–
- æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- CDNåŠ é€Ÿ
- å¼‚æ­¥å¤„ç†

---

## 2. æŠ€æœ¯æ¶æ„è®¾è®¡

### 2.1 åˆ†å±‚æ¶æ„

```mermaid
graph LR
    subgraph "è¡¨ç¤ºå±‚ (Presentation Layer)"
        A1[å°ç¨‹åºå‰ç«¯]
        A2[PCç®¡ç†å‰ç«¯]
        A3[ç§»åŠ¨ç®¡ç†å‰ç«¯]
    end

    subgraph "ç½‘å…³å±‚ (Gateway Layer)"
        B1[è´Ÿè½½å‡è¡¡]
        B2[APIç½‘å…³]
        B3[å®‰å…¨é˜²æŠ¤]
    end

    subgraph "ä¸šåŠ¡å±‚ (Business Layer)"
        C1[ç”¨æˆ·æœåŠ¡]
        C2[è½¦è¾†æœåŠ¡]
        C3[è®¢å•æœåŠ¡]
        C4[æ”¯ä»˜æœåŠ¡]
        C5[ç¤¾åŒºæœåŠ¡]
    end

    subgraph "æ•°æ®å±‚ (Data Layer)"
        D1[å…³ç³»æ•°æ®åº“]
        D2[ç¼“å­˜æ•°æ®åº“]
        D3[æ–‡ä»¶å­˜å‚¨]
    end

    A1 --> B1
    A2 --> B1
    A3 --> B1
    B1 --> B2
    B2 --> B3
    B3 --> C1
    B3 --> C2
    B3 --> C3
    B3 --> C4
    B3 --> C5
    C1 --> D1
    C2 --> D1
    C3 --> D1
    C4 --> D1
    C5 --> D1
    C1 --> D2
    C2 --> D2
    C3 --> D2
    C4 --> D3
```

### 2.2 æŠ€æœ¯æ ˆé€‰å‹

#### å‰ç«¯æŠ€æœ¯æ ˆ
| ç«¯ | æ¡†æ¶ | UIåº“ | çŠ¶æ€ç®¡ç† | æ„å»ºå·¥å…· |
|---|---|---|---|---|
| å°ç¨‹åº | uni-app 3.0 | uni-ui | Vue 3 Composition API | HBuilderX |
| PCç®¡ç†ç«¯ | Vue 3.5 | Element Plus | Vue 3 Composition API | Vite 4.4 |
| ç§»åŠ¨ç®¡ç†ç«¯ | uni-app 3.0 | uni-ui | Vue 3 Composition API | HBuilderX |

#### åç«¯æŠ€æœ¯æ ˆ
| å±‚çº§ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | ç”¨é€” |
|---|---|---|---|
| è¿è¡Œç¯å¢ƒ | Node.js | 18.18.0 LTS | JavaScriptè¿è¡Œæ—¶ |
| Webæ¡†æ¶ | Express.js | 4.18.2 | Webåº”ç”¨æ¡†æ¶ |
| è¯­è¨€ | TypeScript | 5.1.6 | ç±»å‹å®‰å…¨å¼€å‘ |
| æ•°æ®åº“ | MySQL | 8.0.35 | å…³ç³»å‹æ•°æ®å­˜å‚¨ |
| ç¼“å­˜ | Redis | 7.2.3 | å†…å­˜ç¼“å­˜ |
| ORM | Sequelize | 6.32.1 | æ•°æ®åº“ORM |
| è®¤è¯ | JWT | 9.0.2 | ç”¨æˆ·è®¤è¯ |

### 2.3 APIè®¾è®¡æ¶æ„

#### RESTful APIè®¾è®¡
```
/api/v1/{module}/{resource}/{id?}/{action?}
```

**æ¨¡å—åˆ’åˆ†**ï¼š
- `/api/v1/auth/*` - è®¤è¯æˆæƒ
- `/api/v1/users/*` - ç”¨æˆ·ç®¡ç†
- `/api/v1/vehicles/*` - è½¦è¾†ç®¡ç†
- `/api/v1/orders/*` - è®¢å•ç®¡ç†
- `/api/v1/payments/*` - æ”¯ä»˜ç®¡ç†
- `/api/v1/community/*` - ç¤¾åŒºå†…å®¹
- `/api/v1/system/*` - ç³»ç»Ÿç®¡ç†

#### ç»Ÿä¸€å“åº”æ ¼å¼
```json
{
  "code": 0,
  "message": "success",
  "data": {},
  "meta": {
    "timestamp": "2025-11-24T10:00:00+08:00",
    "requestId": "req_123456789"
  }
}
```

---

## 3. ä¸šåŠ¡æ¶æ„è®¾è®¡

### 3.1 ä¸šåŠ¡æ¨¡å—æ¶æ„

```mermaid
graph TB
    subgraph "ç”¨æˆ·ä¸­å¿ƒæ¨¡å—"
        A1[ç”¨æˆ·æ³¨å†Œ]
        A2[ç”¨æˆ·ç™»å½•]
        A3[ç”¨æˆ·ä¿¡æ¯ç®¡ç†]
        A4[æƒé™ç®¡ç†]
    end

    subgraph "è½¦è¾†ç®¡ç†æ¨¡å—"
        B1[è½¦è¾†ä¿¡æ¯]
        B2[è½¦è¾†çŠ¶æ€]
        B3[è½¦è¾†è°ƒåº¦]
        B4[è½¦è¾†ç»´æŠ¤]
    end

    subgraph "è®¢å•ç®¡ç†æ¨¡å—"
        C1[è®¢å•åˆ›å»º]
        C2[è®¢å•çŠ¶æ€]
        C3[è®¢å•æ”¯ä»˜]
        C4[è®¢å•è¯„ä»·]
    end

    subgraph "æ”¯ä»˜ç®¡ç†æ¨¡å—"
        D1[æ”¯ä»˜æ–¹å¼]
        D2[æ”¯ä»˜å¤„ç†]
        D3[é€€æ¬¾ç®¡ç†]
        D4[è´¢åŠ¡ç»Ÿè®¡]
    end

    subgraph "ç¤¾åŒºæ¨¡å—"
        E1[å†…å®¹å‘å¸ƒ]
        E2[å†…å®¹å®¡æ ¸]
        E3[äº’åŠ¨åŠŸèƒ½]
        E4[å†…å®¹æ¨è]
    end

    A1 --> C1
    A2 --> C3
    B1 --> C1
    C1 --> D2
    C3 --> D3
    C4 --> E1
```

### 3.2 æ ¸å¿ƒä¸šåŠ¡æµç¨‹

#### ç”¨æˆ·æ³¨å†Œç™»å½•æµç¨‹
```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant MP as å°ç¨‹åº
    participant API as åç«¯API
    participant DB as æ•°æ®åº“

    U->>MP: ç‚¹å‡»æ³¨å†Œ/ç™»å½•
    MP->>API: å‘èµ·ç™»å½•è¯·æ±‚
    API->>API: éªŒè¯ç”¨æˆ·ä¿¡æ¯
    alt ç”¨æˆ·å­˜åœ¨
        API->>DB: æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
        API->>API: ç”ŸæˆJWT Token
        API->>MP: è¿”å›ç”¨æˆ·ä¿¡æ¯+Token
    else ç”¨æˆ·ä¸å­˜åœ¨
        API->>DB: åˆ›å»ºæ–°ç”¨æˆ·
        API->>API: ç”ŸæˆJWT Token
        API->>MP: è¿”å›ç”¨æˆ·ä¿¡æ¯+Token
    end
    MP->>MP: ä¿å­˜Tokenåˆ°æœ¬åœ°
    MP->>U: ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°é¦–é¡µ
```

#### è®¢å•ä¸šåŠ¡æµç¨‹
```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant MP as å°ç¨‹åº
    participant API as åç«¯API
    participant PAY as æ”¯ä»˜æœåŠ¡
    participant DB as æ•°æ®åº“

    U->>MP: é€‰æ‹©è½¦è¾†ï¼Œåˆ›å»ºè®¢å•
    MP->>API: æäº¤è®¢å•ä¿¡æ¯
    API->>DB: æ£€æŸ¥è½¦è¾†å¯ç”¨æ€§
    API->>DB: åˆ›å»ºè®¢å•è®°å½•
    API->>MP: è¿”å›è®¢å•ä¿¡æ¯

    U->>MP: ç¡®è®¤æ”¯ä»˜
    MP->>API: å‘èµ·æ”¯ä»˜è¯·æ±‚
    API->>PAY: è°ƒç”¨æ”¯ä»˜æ¥å£
    PAY->>API: è¿”å›æ”¯ä»˜ä¿¡æ¯
    API->>MP: è¿”å›æ”¯ä»˜äºŒç»´ç 

    U->>PAY: æ‰«ç æ”¯ä»˜
    PAY->>API: æ”¯ä»˜å›è°ƒé€šçŸ¥
    API->>DB: æ›´æ–°è®¢å•çŠ¶æ€
    API->>MP: æ¨é€æ”¯ä»˜ç»“æœ
    MP->>U: æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸ
```

### 3.3 æœåŠ¡æ‹†åˆ†ç­–ç•¥

#### æŒ‰ä¸šåŠ¡åŸŸæ‹†åˆ†
```typescript
// ç”¨æˆ·æœåŠ¡åŸŸ
interface UserServiceDomain {
  auth: AuthService;
  profile: ProfileService;
  permission: PermissionService;
}

// è½¦è¾†æœåŠ¡åŸŸ
interface VehicleServiceDomain {
  inventory: VehicleInventoryService;
  maintenance: VehicleMaintenanceService;
  scheduling: VehicleSchedulingService;
}

// è®¢å•æœåŠ¡åŸŸ
interface OrderServiceDomain {
  booking: OrderBookingService;
  payment: OrderPaymentService;
  fulfillment: OrderFulfillmentService;
}
```

---

## 4. æ•°æ®æ¶æ„è®¾è®¡

### 4.1 æ•°æ®åº“æ¶æ„

#### ä¸»ä»å¤åˆ¶æ¶æ„
```mermaid
graph LR
    subgraph "åº”ç”¨å±‚"
        A[å†™æ“ä½œ]
        B[è¯»æ“ä½œ]
    end

    subgraph "æ•°æ®åº“å±‚"
        C[MySQLä¸»åº“<br/>å†™æ“ä½œ]
        D[MySQLä»åº“1<br/>è¯»æ“ä½œ]
        E[MySQLä»åº“2<br/>è¯»æ“ä½œ]
    end

    A --> C
    B --> D
    B --> E
    C --> D
    C --> E
```

#### æ•°æ®åˆ†ç‰‡ç­–ç•¥
```sql
-- ç”¨æˆ·è¡¨åˆ†ç‰‡ï¼ˆæŒ‰ç”¨æˆ·IDå“ˆå¸Œï¼‰
CREATE TABLE users_shard_0 LIKE users;
CREATE TABLE users_shard_1 LIKE users;
CREATE TABLE users_shard_2 LIKE users;
CREATE TABLE users_shard_3 LIKE users;

-- è®¢å•è¡¨åˆ†ç‰‡ï¼ˆæŒ‰æ—¶é—´åˆ†ç‰‡ï¼‰
CREATE TABLE orders_2024_q1 LIKE orders;
CREATE TABLE orders_2024_q2 LIKE orders;
CREATE TABLE orders_2024_q3 LIKE orders;
CREATE TABLE orders_2024_q4 LIKE orders;
```

### 4.2 ç¼“å­˜æ¶æ„

#### Redisç¼“å­˜å±‚çº§
```mermaid
graph TB
    subgraph "ç¼“å­˜å±‚çº§"
        A[L1: æœ¬åœ°ç¼“å­˜<br/>åº”ç”¨å†…å­˜]
        B[L2: åˆ†å¸ƒå¼ç¼“å­˜<br/>Redisé›†ç¾¤]
        C[L3: æŒä¹…åŒ–ç¼“å­˜<br/>RedisæŒä¹…åŒ–]
    end

    subgraph "æ•°æ®æº"
        D[MySQLæ•°æ®åº“]
    end

    A --> B
    B --> C
    C --> D

    subgraph "ç¼“å­˜ç­–ç•¥"
        E[çƒ­ç‚¹æ•°æ®<br/>TTL: 1å°æ—¶]
        F[ç”¨æˆ·ä¼šè¯<br/>TTL: 24å°æ—¶]
        G[é…ç½®æ•°æ®<br/>TTL: 30åˆ†é’Ÿ]
    end

    B --> E
    B --> F
    B --> G
```

#### ç¼“å­˜æ›´æ–°ç­–ç•¥
```typescript
// Cache-Asideæ¨¡å¼
class CacheService {
  async get<T>(key: string): Promise<T | null> {
    // 1. å…ˆæŸ¥ç¼“å­˜
    let data = await redis.get(key);
    if (data) {
      return JSON.parse(data);
    }

    // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“
    data = await database.findById(key);
    if (data) {
      // 3. å†™å…¥ç¼“å­˜
      await redis.setex(key, 3600, JSON.stringify(data));
    }

    return data;
  }

  async update<T>(key: string, data: T): Promise<void> {
    // 1. æ›´æ–°æ•°æ®åº“
    await database.update(key, data);

    // 2. åˆ é™¤ç¼“å­˜
    await redis.del(key);
  }
}
```

### 4.3 æ•°æ®åŒæ­¥æ¶æ„

#### æ•°æ®åŒæ­¥æµç¨‹
```mermaid
graph LR
    subgraph "æ•°æ®æº"
        A[è®¢å•æœåŠ¡]
        B[ç”¨æˆ·æœåŠ¡]
        C[æ”¯ä»˜æœåŠ¡]
    end

    subgraph "æ¶ˆæ¯é˜Ÿåˆ—"
        D[Redis Streams]
    end

    subgraph "æ•°æ®æ¶ˆè´¹"
        E[æœç´¢å¼•æ“]
        F[æ•°æ®ä»“åº“]
        G[ç¼“å­˜æ›´æ–°]
    end

    A --> D
    B --> D
    C --> D
    D --> E
    D --> F
    D --> G
```

---

## 5. å®‰å…¨æ¶æ„è®¾è®¡

### 5.1 å¤šå±‚å®‰å…¨é˜²æŠ¤

```mermaid
graph TB
    subgraph "ç½‘ç»œå®‰å…¨å±‚"
        A[WAFé˜²ç«å¢™]
        B[DDoSé˜²æŠ¤]
        C[SSL/TLSåŠ å¯†]
    end

    subgraph "åº”ç”¨å®‰å…¨å±‚"
        D[APIè®¤è¯]
        E[æƒé™æ§åˆ¶]
        F[è¾“å…¥éªŒè¯]
        G[SQLæ³¨å…¥é˜²æŠ¤]
    end

    subgraph "æ•°æ®å®‰å…¨å±‚"
        H[æ•°æ®åŠ å¯†]
        I[æ•æ„Ÿæ•°æ®è„±æ•]
        J[æ•°æ®å¤‡ä»½]
        K[è®¿é—®å®¡è®¡]
    end

    subgraph "åŸºç¡€è®¾æ–½å®‰å…¨å±‚"
        L[å®¹å™¨å®‰å…¨]
        M[ç½‘ç»œå®‰å…¨ç»„]
        N[è®¿é—®æ§åˆ¶]
    end

    A --> D
    B --> D
    C --> D
    D --> H
    E --> H
    F --> H
    G --> H
    H --> L
    I --> L
    J --> L
    K --> L
```

### 5.2 è®¤è¯æˆæƒæ¶æ„

#### JWTè®¤è¯æµç¨‹
```mermaid
sequenceDiagram
    participant C as å®¢æˆ·ç«¯
    participant A as APIç½‘å…³
    participant S as è®¤è¯æœåŠ¡
    participant R as Redis
    participant B as ä¸šåŠ¡æœåŠ¡

    C->>A: è¯·æ±‚ + Token
    A->>S: éªŒè¯Token
    alt Tokenæœ‰æ•ˆ
        S->>R: æ£€æŸ¥Tokené»‘åå•
        alt Tokenä¸åœ¨é»‘åå•
            S->>A: è¿”å›ç”¨æˆ·ä¿¡æ¯
            A->>B: è½¬å‘è¯·æ±‚ + ç”¨æˆ·ä¿¡æ¯
            B->>A: è¿”å›å“åº”
            A->>C: è¿”å›ç»“æœ
        else Tokenåœ¨é»‘åå•
            S->>A: Tokenå·²å¤±æ•ˆ
            A->>C: 401æœªæˆæƒ
        end
    else Tokenæ— æ•ˆ
        S->>A: TokenéªŒè¯å¤±è´¥
        A->>C: 401æœªæˆæƒ
    end
```

#### æƒé™æ§åˆ¶æ¨¡å‹
```typescript
// RBACæƒé™æ¨¡å‹
interface Role {
  id: number;
  name: string;
  permissions: Permission[];
}

interface Permission {
  id: number;
  resource: string;  // èµ„æºï¼šorder, user, vehicle
  action: string;    // æ“ä½œï¼šread, write, delete
  scope: string;     // èŒƒå›´ï¼šall, store, self
}

// æƒé™æ£€æŸ¥ä¸­é—´ä»¶
const checkPermission = (resource: string, action: string) => {
  return (req, res, next) => {
    const { user } = req;
    const hasPermission = user.permissions.some(
      p => p.resource === resource &&
           p.action === action &&
           checkScope(p.scope, user, req)
    );

    if (!hasPermission) {
      return res.status(403).json({
        code: 403003,
        message: 'æƒé™ä¸è¶³'
      });
    }

    next();
  };
};
```

### 5.3 æ•°æ®å®‰å…¨ç­–ç•¥

#### æ•æ„Ÿæ•°æ®åŠ å¯†
```typescript
// AESåŠ å¯†æ•æ„Ÿæ•°æ®
class DataEncryption {
  private readonly algorithm = 'aes-256-gcm';
  private readonly keyLength = 32;

  encrypt(text: string): string {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipher(this.algorithm, this.getEncryptionKey());
    cipher.setAAD(Buffer.from('daodao-rv', 'utf8'));

    let encrypted = cipher.update(text, 'utf8', 'hex');
    encrypted += cipher.final('hex');

    const authTag = cipher.getAuthTag();
    return iv.toString('hex') + ':' + authTag.toString('hex') + ':' + encrypted;
  }

  decrypt(encryptedData: string): string {
    const parts = encryptedData.split(':');
    const iv = Buffer.from(parts[0], 'hex');
    const authTag = Buffer.from(parts[1], 'hex');
    const encrypted = parts[2];

    const decipher = crypto.createDecipher(this.algorithm, this.getEncryptionKey());
    decipher.setAAD(Buffer.from('daodao-rv', 'utf8'));
    decipher.setAuthTag(authTag);

    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');

    return decrypted;
  }
}
```

---

## 6. éƒ¨ç½²æ¶æ„è®¾è®¡

### 6.1 å®¹å™¨åŒ–éƒ¨ç½²æ¶æ„

```mermaid
graph TB
    subgraph "è´Ÿè½½å‡è¡¡å±‚"
        A[Nginx Ingress]
    end

    subgraph "åº”ç”¨å±‚"
        B[Backend Pod 1]
        C[Backend Pod 2]
        D[Backend Pod 3]
    end

    subgraph "æ•°æ®å±‚"
        E[MySQL Master]
        F[MySQL Slave]
        G[Redis Cluster]
    end

    subgraph "ç›‘æ§å±‚"
        H[Prometheus]
        I[Grafana]
        J[ELK Stack]
    end

    A --> B
    A --> C
    A --> D
    B --> E
    C --> E
    D --> E
    E --> F
    B --> G
    C --> G
    D --> G

    B --> H
    C --> H
    D --> H
    H --> I
    H --> J
```

### 6.2 Dockerå®¹å™¨ç¼–æ’

#### docker-compose.yml
```yaml
version: '3.8'

services:
  # åç«¯APIæœåŠ¡
  backend:
    build: ./backend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=mysql://user:pass@mysql:3306/daodao
      - REDIS_URL=redis://redis:6379
    depends_on:
      - mysql
      - redis
    deploy:
      replicas: 3
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # MySQLæ•°æ®åº“
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: daodao
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"

  # Redisç¼“å­˜
  redis:
    image: redis:7.2-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  # Nginxè´Ÿè½½å‡è¡¡
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - backend

volumes:
  mysql_data:
  redis_data:
```

### 6.3 CI/CDæµæ°´çº¿

#### GitLab CIé…ç½®
```yaml
# .gitlab-ci.yml
stages:
  - build
  - test
  - deploy

variables:
  DOCKER_REGISTRY: registry.gitlab.com/daodao
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA

build:
  stage: build
  script:
    - docker build -t $DOCKER_REGISTRY/backend:$IMAGE_TAG ./backend
    - docker push $DOCKER_REGISTRY/backend:$IMAGE_TAG

test:
  stage: test
  script:
    - npm run test:unit
    - npm run test:integration
  coverage: '/Coverage: \d+\.\d+%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

deploy_staging:
  stage: deploy
  environment: staging
  script:
    - kubectl set image deployment/backend backend=$DOCKER_REGISTRY/backend:$IMAGE_TAG
    - kubectl rollout status deployment/backend
  only:
    - develop

deploy_production:
  stage: deploy
  environment: production
  script:
    - kubectl set image deployment/backend backend=$DOCKER_REGISTRY/backend:$IMAGE_TAG
    - kubectl rollout status deployment/backend
  when: manual
  only:
    - main
```

---

## 7. æ€§èƒ½æ¶æ„è®¾è®¡

### 7.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

```mermaid
graph TB
    subgraph "å‰ç«¯æ€§èƒ½ä¼˜åŒ–"
        A[ä»£ç åˆ†å‰²]
        B[æ‡’åŠ è½½]
        C[CDNåŠ é€Ÿ]
        D[å›¾ç‰‡ä¼˜åŒ–]
    end

    subgraph "ç½‘ç»œæ€§èƒ½ä¼˜åŒ–"
        E[HTTP/2]
        F[GZIPå‹ç¼©]
        G[ç¼“å­˜ç­–ç•¥]
        H[è¿æ¥æ± ]
    end

    subgraph "åº”ç”¨æ€§èƒ½ä¼˜åŒ–"
        I[æ•°æ®åº“ä¼˜åŒ–]
        J[ç¼“å­˜ç­–ç•¥]
        K[å¼‚æ­¥å¤„ç†]
        L[è¿æ¥å¤ç”¨]
    end

    subgraph "ç›‘æ§å’Œè°ƒä¼˜"
        M[æ€§èƒ½ç›‘æ§]
        N[ç“¶é¢ˆåˆ†æ]
        O[è‡ªåŠ¨æ‰©ç¼©å®¹]
    end

    A --> E
    B --> F
    C --> G
    D --> H
    E --> I
    F --> J
    G --> K
    H --> L
    I --> M
    J --> N
    K --> O
    L --> M
```

### 7.2 æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

#### ç´¢å¼•ä¼˜åŒ–ç­–ç•¥
```sql
-- ç”¨æˆ·è¡¨ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status_created ON users(status, created_at);

-- è®¢å•è¡¨ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_orders_user_status ON orders(user_id, status);
CREATE INDEX idx_orders_vehicle_dates ON orders(vehicle_id, pickup_time, return_time);
CREATE INDEX idx_orders_status_created ON orders(status, created_at);

-- å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX idx_orders_composite ON orders(user_id, status, created_at DESC);
```

#### æŸ¥è¯¢ä¼˜åŒ–
```typescript
// åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
class OrderService {
  async getOrders(params: GetOrdersParams) {
    const { page = 1, pageSize = 20, userId, status } = params;

    // ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µæ›¿ä»£OFFSET
    let query = `
      SELECT o.*, u.username, v.license_plate
      FROM orders o
      LEFT JOIN users u ON o.user_id = u.id
      LEFT JOIN vehicles v ON o.vehicle_id = v.id
      WHERE 1=1
    `;

    const params: any[] = [];

    if (userId) {
      query += ' AND o.user_id = ?';
      params.push(userId);
    }

    if (status) {
      query += ' AND o.status = ?';
      params.push(status);
    }

    // ä½¿ç”¨ç´¢å¼•æ’åº
    query += ' ORDER BY o.created_at DESC LIMIT ?';
    params.push(pageSize);

    if (page > 1) {
      query += ' OFFSET ?';
      params.push((page - 1) * pageSize);
    }

    return await this.db.query(query, params);
  }
}
```

### 7.3 ç¼“å­˜æ€§èƒ½ä¼˜åŒ–

#### å¤šçº§ç¼“å­˜æ¶æ„
```typescript
class MultiLevelCache {
  private l1Cache = new Map<string, any>();  // å†…å­˜ç¼“å­˜
  private l2Cache: Redis;                    // Redisç¼“å­˜

  async get<T>(key: string): Promise<T | null> {
    // L1ç¼“å­˜å‘½ä¸­
    if (this.l1Cache.has(key)) {
      const item = this.l1Cache.get(key);
      if (item.expiry > Date.now()) {
        return item.value;
      }
      this.l1Cache.delete(key);
    }

    // L2ç¼“å­˜å‘½ä¸­
    const l2Data = await this.l2Cache.get(key);
    if (l2Data) {
      const data = JSON.parse(l2Data);
      // å›å¡«L1ç¼“å­˜
      this.l1Cache.set(key, {
        value: data,
        expiry: Date.now() + 5 * 60 * 1000  // 5åˆ†é’Ÿ
      });
      return data;
    }

    return null;
  }

  async set<T>(key: string, value: T, ttl: number = 3600): Promise<void> {
    // è®¾ç½®L1ç¼“å­˜
    this.l1Cache.set(key, {
      value,
      expiry: Date.now() + Math.min(ttl, 5 * 60) * 1000
    });

    // è®¾ç½®L2ç¼“å­˜
    await this.l2Cache.setex(key, ttl, JSON.stringify(value));
  }
}
```

---

## 8. ç›‘æ§æ¶æ„è®¾è®¡

### 8.1 å…¨é“¾è·¯ç›‘æ§

```mermaid
graph TB
    subgraph "åº”ç”¨ç›‘æ§"
        A[APMç›‘æ§]
        B[é”™è¯¯è¿½è¸ª]
        C[æ€§èƒ½åˆ†æ]
    end

    subgraph "åŸºç¡€è®¾æ–½ç›‘æ§"
        D[æœåŠ¡å™¨ç›‘æ§]
        E[æ•°æ®åº“ç›‘æ§]
        F[ç½‘ç»œç›‘æ§]
    end

    subgraph "ä¸šåŠ¡ç›‘æ§"
        G[ç”¨æˆ·è¡Œä¸º]
        H[ä¸šåŠ¡æŒ‡æ ‡]
        I[å¼‚å¸¸å‘Šè­¦]
    end

    subgraph "æ—¥å¿—ç®¡ç†"
        J[æ—¥å¿—æ”¶é›†]
        K[æ—¥å¿—åˆ†æ]
        L[æ—¥å¿—æœç´¢]
    end

    A --> D
    B --> E
    C --> F
    D --> G
    E --> H
    F --> I
    G --> J
    H --> K
    I --> L
```

### 8.2 ç›‘æ§æŒ‡æ ‡ä½“ç³»

#### æŠ€æœ¯æŒ‡æ ‡
```typescript
interface TechnicalMetrics {
  // åº”ç”¨æ€§èƒ½æŒ‡æ ‡
  responseTime: number;        // å“åº”æ—¶é—´
  throughput: number;         // ååé‡
  errorRate: number;          // é”™è¯¯ç‡
  availability: number;       // å¯ç”¨æ€§

  // ç³»ç»Ÿèµ„æºæŒ‡æ ‡
  cpuUsage: number;           // CPUä½¿ç”¨ç‡
  memoryUsage: number;        // å†…å­˜ä½¿ç”¨ç‡
  diskUsage: number;          // ç£ç›˜ä½¿ç”¨ç‡
  networkIO: number;          // ç½‘ç»œIO

  // æ•°æ®åº“æŒ‡æ ‡
  dbConnections: number;      // æ•°æ®åº“è¿æ¥æ•°
  dbQueryTime: number;        // æŸ¥è¯¢å“åº”æ—¶é—´
  dbSlowQueries: number;      // æ…¢æŸ¥è¯¢æ•°é‡

  // ç¼“å­˜æŒ‡æ ‡
  cacheHitRate: number;       // ç¼“å­˜å‘½ä¸­ç‡
  cacheMemory: number;        // ç¼“å­˜å†…å­˜ä½¿ç”¨
}
```

#### ä¸šåŠ¡æŒ‡æ ‡
```typescript
interface BusinessMetrics {
  // ç”¨æˆ·æŒ‡æ ‡
  activeUsers: number;        // æ´»è·ƒç”¨æˆ·æ•°
  userRetention: number;      // ç”¨æˆ·ç•™å­˜ç‡
  conversionRate: number;     // è½¬åŒ–ç‡

  // è®¢å•æŒ‡æ ‡
  orderVolume: number;        // è®¢å•é‡
  orderValue: number;         // è®¢å•é‡‘é¢
  orderCompletionRate: number; // è®¢å•å®Œæˆç‡

  // æ”¯ä»˜æŒ‡æ ‡
  paymentSuccessRate: number; // æ”¯ä»˜æˆåŠŸç‡
  paymentAmount: number;      // æ”¯ä»˜é‡‘é¢
  refundRate: number;         // é€€æ¬¾ç‡
}
```

### 8.3 å‘Šè­¦ç­–ç•¥

#### å‘Šè­¦çº§åˆ«å®šä¹‰
```typescript
enum AlertLevel {
  CRITICAL = 'critical',    // ç´§æ€¥ï¼šç³»ç»Ÿä¸å¯ç”¨
  WARNING = 'warning',      // è­¦å‘Šï¼šæ€§èƒ½ä¸‹é™
  INFO = 'info'            // ä¿¡æ¯ï¼šçŠ¶æ€å˜æ›´
}

interface AlertRule {
  name: string;
  condition: string;
  level: AlertLevel;
  duration: number;        // æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰
  channels: string[];       // é€šçŸ¥æ¸ é“
}

const alertRules: AlertRule[] = [
  {
    name: 'æœåŠ¡ä¸å¯ç”¨',
    condition: 'availability < 99.9',
    level: AlertLevel.CRITICAL,
    duration: 60,
    channels: ['sms', 'phone', 'email']
  },
  {
    name: 'å“åº”æ—¶é—´è¿‡é•¿',
    condition: 'responseTime > 2000',
    level: AlertLevel.WARNING,
    duration: 300,
    channels: ['email', 'slack']
  },
  {
    name: 'é”™è¯¯ç‡è¿‡é«˜',
    condition: 'errorRate > 5',
    level: AlertLevel.WARNING,
    duration: 180,
    channels: ['email', 'slack']
  }
];
```

---

## æ¶æ„æ¼”è¿›è§„åˆ’

### çŸ­æœŸä¼˜åŒ–ï¼ˆ3ä¸ªæœˆå†…ï¼‰
- [ ] å®Œå–„APIè·¯ç”±æ³¨å†Œå’Œé”™è¯¯å¤„ç†
- [ ] å»ºç«‹å®Œæ•´çš„æµ‹è¯•ä½“ç³»
- [ ] ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- [ ] å®ç°Redisç¼“å­˜ç­–ç•¥
- [ ] å®Œå–„æ—¥å¿—è®°å½•å’Œç›‘æ§

### ä¸­æœŸæ¼”è¿›ï¼ˆ6ä¸ªæœˆå†…ï¼‰
- [ ] å¾®æœåŠ¡æ¶æ„æ”¹é€ 
- [ ] å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—
- [ ] å®ç°æœåŠ¡ç½‘æ ¼
- [ ] å»ºç«‹å®Œæ•´çš„æ•°æ®ä»“åº“
- [ ] å®ç°è‡ªåŠ¨åŒ–è¿ç»´

### é•¿æœŸè§„åˆ’ï¼ˆ12ä¸ªæœˆå†…ï¼‰
- [ ] å¤šäº‘éƒ¨ç½²æ¶æ„
- [ ] å¤§æ•°æ®å¹³å°å»ºè®¾
- [ ] AIèƒ½åŠ›é›†æˆ
- [ ] è¾¹ç¼˜è®¡ç®—æ”¯æŒ
- [ ] å…¨çƒåŒ–éƒ¨ç½²

---

## æ€»ç»“

æœ¬æ–‡æ¡£ä»æŠ€æœ¯æ¶æ„ã€ä¸šåŠ¡æ¶æ„ã€æ•°æ®æ¶æ„ã€å®‰å…¨æ¶æ„ã€éƒ¨ç½²æ¶æ„ã€æ€§èƒ½æ¶æ„å’Œç›‘æ§æ¶æ„ç­‰å¤šä¸ªç»´åº¦ï¼Œå…¨é¢æè¿°äº†å¨å¨æˆ¿è½¦ç³»ç»Ÿçš„æ¶æ„è®¾è®¡ã€‚

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
1. **é«˜å¯ç”¨æ€§**ï¼šå¤šå±‚å†—ä½™è®¾è®¡ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œ
2. **å¯æ‰©å±•æ€§**ï¼šæ¨¡å—åŒ–æ¶æ„ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•
3. **å®‰å…¨æ€§**ï¼šå¤šå±‚å®‰å…¨é˜²æŠ¤ï¼Œä¿æŠ¤æ•°æ®å’Œç³»ç»Ÿå®‰å…¨
4. **é«˜æ€§èƒ½**ï¼šå¤šç§ä¼˜åŒ–ç­–ç•¥ï¼Œæä¾›ä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒ
5. **å¯è§‚æµ‹æ€§**ï¼šå®Œæ•´çš„ç›‘æ§ä½“ç³»ï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³é—®é¢˜

**å…³é”®æˆåŠŸå› ç´ **ï¼š
- ä¸¥æ ¼æŒ‰ç…§æ¶æ„è®¾è®¡è¿›è¡Œå¼€å‘
- æŒç»­çš„æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–
- å®Œå–„çš„å®‰å…¨é˜²æŠ¤æªæ–½
- è§„èŒƒçš„è¿ç»´æµç¨‹
- å›¢é˜ŸæŠ€èƒ½æŒç»­æå‡

---

**æ–‡æ¡£ç»´æŠ¤**: å¨å¨æˆ¿è½¦æŠ€æœ¯å›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2025-11-24
**ç‰ˆæœ¬**: v1.0
**ä¸‹æ¬¡å®¡æ ¸**: 2025-12-24