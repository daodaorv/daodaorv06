# 技术栈与架构设计

**文档版本**: v5.1 | **创建时间**: 2025-11-10 | **更新时间**: 2025-11-22 | **维护者**: 叨叨房车技术团队

## 📋 文档说明

本文档定义叨叨房车项目的技术栈、API规则和技术实现规范，供开发AI和开发人员参考。

**关联文档**：
- [小程序端功能设计.md](./小程序端功能设计.md) - 业务功能需求
- [管理端功能设计.md](./管理端功能设计.md) - 业务功能需求
- [移动管理端详细设计.md](./移动管理端详细设计.md) - 业务功能需求

---

## 📋 目录

1. [技术栈总览](#1-技术栈总览)
2. [各端技术栈详细规范](#2-各端技术栈详细规范)
3. [后端API技术栈](#3-后端api技术栈)
4. [API设计规范](#4-api设计规范)
5. [核心业务规则技术实现](#5-核心业务规则技术实现)
6. [开发环境快速启动](#6-开发环境快速启动)

---

## 1. 技术栈总览

### 1.1 技术栈矩阵

| 端 | 类型 | 框架 | UI组件库 | 状态管理 | 构建工具 | 开发语言 | 项目路径 |
|---|---|---|---|---|---|---|---|---|
| **C端小程序** | 用户端 | uni-app 3.x | uni-ui | Vue 3 Composition API | HBuilderX | Vue 3 + TypeScript | `miniprogram/` |
| **B端PC管理** | 管理端 | Vue 3 + Vite | Element Plus | Vue 3 Composition API | VS Code | Vue 3 + TypeScript | `admin-console/` |
| **B端移动管理** | 管理端 | uni-app 3.x | uni-ui | Vue 3 Composition API | HBuilderX | Vue 3 + TypeScript | `mobile-admin/` |
| **后端API** | 服务端 | Express.js 4.x | - | - | Node.js 18.x | TypeScript | `backend/` |

### 1.2 关键依赖版本表

| 依赖项 | C端小程序 | B端PC管理 | B端移动管理 | 后端API | 对应项目路径 |
|--------|----------|----------|------------|---------|----------------|
| Vue | 3.5.0 | 3.5.0 | 3.5.0 | - | `admin-console/src/` |
| uni-app | 3.0.0 | - | 3.0.0 | - | `miniprogram/`, `mobile-admin/` |
| Element Plus | - | 2.11.7 | - | - | `admin-console/src/` |
| uni-ui | 官方组件库 | - | 官方组件库 | - | `miniprogram/`, `mobile-admin/` |
| @dcloudio/uni-ui | 1.4.28 | - | 1.4.28 | - | `miniprogram/` |
| 自定义组件 | 32个组件 | - | 32个组件 | - | `miniprogram/components/` |
| Express.js | - | - | - | 4.18.2 | `backend/` |
| MySQL | - | - | - | 8.0.35 | `backend/` (Docker) |
| Node.js | - | - | - | 18.18.0 LTS | 全局环境 |
| TypeScript | 5.1.6 | 5.1.6 | 5.1.6 | 5.1.6 | `admin-console/src/`, `backend/src/` |
| Vite | - | 4.4.9 | - | - | `admin-console/` |
| Sequelize | - | - | - | 6.32.1 | `backend/` |
| jsonwebtoken | - | - | - | 9.0.2 | `backend/` |
| node-cron | - | - | - | 3.0.3 | `backend/` |
| multer | - | - | - | 1.4.5-lts.1 | `backend/` |
| bcrypt | - | - | - | 5.1.1 | `backend/` |
| cors | - | - | - | 2.8.5 | `backend/` |
| helmet | - | - | - | 7.1.0 | `backend/` |

---

## 2. 各端技术栈详细规范

### 2.1 C端小程序技术栈

#### 📍 **项目路径**: `miniprogram/`

#### 开发环境
- **开发工具**: HBuilderX
- **编译运行**: 微信开发者工具
- **调试工具**: 微信开发者工具控制台

#### 核心框架
- **uni-app**: 3.0.0
- **Vue**: 3.5.0
- **TypeScript**: 5.1.6
- **JavaScript**: ES6+

#### 项目结构
```
miniprogram/
├── pages/                 # 页面文件
│   ├── index/             # 首页
│   ├── user/              # 用户相关页面
│   └── order/             # 订单相关页面
├── components/            # 公共组件
├── static/                # 静态资源
├── utils/                 # 工具函数
├── store/                 # 状态管理
├── manifest.json          # 应用配置
├── pages.json            # 页面配置
├── App.vue               # 应用入口
└── main.ts               # 主入口文件
```

#### UI组件库
- **uni-ui**: 官方组件库
- 组件使用优先级：uni-app内置组件 > uni-ui组件 > 自定义业务组件

#### 状态管理
- **Vue 3 Composition API**: 使用 `reactive`、`ref` 管理状态
- 按业务模块划分store，避免过度抽象

#### 平台支持
- 微信小程序：基础库 >= 2.19.0
- H5网页：响应式设计，移动端友好

### 2.2 B端PC管理端技术栈

#### 📍 **项目路径**: `admin-console/`

#### 开发环境
- **开发工具**: VS Code
- **构建运行**: Vite + Node.js
- **调试工具**: Vue DevTools + Browser DevTools

#### 核心框架
- **Vue**: 3.5.0 (Composition API)
- **TypeScript**: 5.1.6
- **Vite**: 4.4.9 (构建工具)
- **Vue Router**: 4.2.5 (路由管理)

#### 项目结构
```
admin-console/
├── src/
│   ├── views/               # 页面组件
│   │   ├── Dashboard.vue   # 仪表盘
│   │   ├── Login.vue       # 登录页
│   │   └── 404.vue         # 404页面
│   ├── components/          # 公共组件
│   ├── router/              # 路由配置
│   ├── store/               # 状态管理
│   ├── api/                 # API接口
│   ├── utils/               # 工具函数
│   ├── assets/              # 静态资源
│   ├── styles/              # 样式文件
│   ├── App.vue             # 应用根组件
│   └── main.ts             # 应用入口
├── index.html              # HTML模板
├── vite.config.ts          # Vite配置
├── package.json            # 依赖管理
└── tsconfig.json           # TypeScript配置
```

#### UI组件库
- **Element Plus**: 2.11.7 (按需引入)
- **自动导入**: unplugin-auto-import + unplugin-vue-components
- **移动端响应式适配**: CSS媒体查询 + Element Plus栅格系统

### 2.3 B端移动管理端技术栈

#### 📍 **项目路径**: `mobile-admin/`

#### 开发环境
- **开发工具**: HBuilderX
- **编译运行**: 微信开发者工具
- **调试工具**: 微信开发者工具控制台

#### 核心框架
- **uni-app**: 3.0.0
- **Vue**: 3.5.0
- **TypeScript**: 5.1.6

#### 项目结构
```
mobile-admin/
├── pages/                 # 管理页面
│   ├── dashboard/         # 管理仪表盘
│   ├── order/             # 订单管理
│   ├── user/              # 用户管理
│   └── settings/          # 系统设置
├── components/            # 管理组件
├── static/                # 静态资源
├── utils/                 # 工具函数
├── store/                 # 状态管理
├── manifest.json          # 应用配置
├── pages.json            # 页面配置
├── App.vue               # 应用入口
└── main.ts               # 主入口文件
```

#### UI组件库
- **uni-ui**: 官方组件库
- 移动端优化组件

#### 特色功能
- 离线数据存储
- 拍照上传优化
- 触摸操作优化

---

## 3. 后端API技术栈

### 📍 **项目路径**: `backend/`

### 3.1 运行环境
- **Node.js**: 18.18.0 LTS
- **TypeScript**: 5.1.6
- **数据库**: MySQL 8.0.35 (Docker)
- **缓存**: Redis 7.2.3 (Docker)

### 3.2 核心框架
- **Express.js**: 4.18.2 + @types/express
- **数据库驱动**: mysql2 3.6.5 + @types/mysql2
- **ORM**: Sequelize 6.32.1 + @types/sequelize
- **类型验证**: class-validator 0.14.0 + class-transformer 0.5.1

### 3.3 项目结构
```
backend/
├── src/                    # TypeScript源代码
│   ├── app.ts             # 应用入口文件
│   ├── server.ts          # 服务器启动文件
│   ├── routes/            # 路由定义
│   │   └── index.ts       # 路由入口
│   ├── controllers/       # 控制器层
│   ├── models/            # 数据模型层
│   ├── middleware/        # 中间件
│   ├── utils/             # 工具函数
│   ├── types/             # 类型定义
│   └── config/            # 配置文件
│       └── database.ts    # 数据库配置
├── package.json           # 依赖管理
├── tsconfig.json           # TypeScript配置
├── .env.example           # 环境变量示例
├── .env                   # 环境变量配置
├── dist/                  # 编译输出目录
└── README.md              # 项目说明
```
├── services/              # 业务服务层
└── tests/                 # 测试文件
```

### 3.4 数据库配置
- **MySQL**: 8.0.35
  - 字符集: utf8mb4
  - 排序规则: utf8mb4_unicode_ci
  - 时区: +08:00
- **Redis**: 7.2.3
- **Docker配置**: `docker-compose.yml`

### 3.5 其他核心依赖
- **JWT**: jsonwebtoken 9.0.2 (认证授权)
- **node-cron**: 3.0.3 (定时任务)
- **multer**: 1.4.5-lts.1 (文件上传)
- **bcrypt**: 5.1.1 (密码加密)
- **cors**: 2.8.5 (跨域处理)
- **helmet**: 7.1.0 (安全中间件)

---

## 4. API设计规范

### 4.1 API架构设计
- **统一API入口**：三端使用统一API路径，通过JWT角色权限控制访问范围
- **路径结构**：`/api/v1/{module}/` 不按端隔离，按业务模块划分
- **权限控制**：基于JWT Token中的用户类型和权限进行验证

#### API路径设计
```
/api/v1/auth/*           - 认证相关API
/api/v1/users/*          - 用户管理API
/api/v1/vehicles/*       - 车辆管理API
/api/v1/orders/*         - 订单管理API
/api/v1/payments/*       - 支付相关API
/api/v1/content/*        - 内容管理API
/api/v1/system/*         - 系统管理API
```

#### JWT Token结构
```json
{
  "userId": 12345,
  "userType": "customer|mobile_admin|pc_admin",
  "roleId": 2,
  "permissions": ["order:read", "order:create"],
  "storeId": 5,
  "exp": 1736789400,
  "iat": 1736703000
}
```

### 4.2 基础约定
- **协议**: HTTPS
- **风格**: RESTful
- **命名**: 小写、连字符，如 `/api/orders`, `/api/user-tags`
- **版本**: 路径前缀 `/api/v1/...`
- **编码**: UTF-8, JSON格式
- **时区**: UTC+8, ISO8601格式

### 4.3 请求格式
- **Header**: `Content-Type: application/json`
- **认证**: `Authorization: Bearer <token>` (JWT)
- **分页**: `page` (从1开始), `pageSize` (默认20, 最大100)
- **排序**: `sort=createdAt,desc`

### 4.4 权限控制示例

#### 数据访问权限
```javascript
// 订单列表API权限控制
GET /api/v1/orders
- C端用户: 只能查看自己的订单 (user_id = 当前用户ID)
- 移动管理端: 只能查看本门店订单 (store_id = 当前用户门店ID)
- PC管理端: 根据角色权限查看相应范围订单
```

#### 操作权限
```javascript
// 订单操作权限
POST /api/v1/orders              - 创建订单 (C端用户)
PUT /api/v1/orders/:id/confirm  - 确认订单 (管理端)
PUT /api/v1/orders/:id/cancel   - 取消订单 (所有端，权限验证)
```

### 4.5 统一响应格式

**基础响应结构**:
```json
{
  "code": 0,
  "message": "success",
  "data": {},
  "meta": {
    "requestId": "abc-123",
    "timestamp": "2025-11-12T10:00:00+08:00"
  }
}
```

**成功响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": 123,
    "name": "订单名称",
    "status": "pending"
  },
  "meta": {
    "requestId": "req_1736728800000_001",
    "timestamp": "2025-11-12T10:00:00+08:00"
  }
}
```

**分页响应**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {"id": 1, "name": "订单1"},
    {"id": 2, "name": "订单2"}
  ],
  "pagination": {
    "page": 1,
    "pageSize": 20,
    "total": 150,
    "pages": 8
  },
  "meta": {
    "requestId": "req_1736728800000_002",
    "timestamp": "2025-11-12T10:00:00+08:00"
  }
}
```

**错误响应**:
```json
{
  "code": 100102,
  "message": "ORDER_NOT_FOUND",
  "details": "订单不存在或已取消",
  "meta": {
    "requestId": "req_1736728800000_003",
    "timestamp": "2025-11-12T10:00:00+08:00"
  }
}
```

**验证错误响应**:
```json
{
  "code": 100001,
  "message": "VALIDATION_ERROR",
  "details": "请求参数验证失败",
  "errors": [
    {
      "field": "email",
      "message": "邮箱格式不正确"
    },
    {
      "field": "phone",
      "message": "手机号不能为空"
    }
  ],
  "meta": {
    "requestId": "req_1736728800000_004",
    "timestamp": "2025-11-12T10:00:00+08:00"
  }
}
```

### 4.6 标准错误码体系

#### HTTP状态码规范
- **200**: 请求成功
- **201**: 创建成功
- **400**: 请求参数错误
- **401**: 未授权/Token无效
- **403**: 权限不足
- **404**: 资源不存在
- **409**: 资源冲突
- **422**: 请求参数验证失败
- **429**: 请求频率超限
- **500**: 服务器内部错误
- **502**: 网关错误
- **503**: 服务不可用

#### 业务错误码规范

**通用错误码 (100000-199999)**:
```
100000: 系统内部错误
100001: 请求参数验证失败
100002: 请求频率过高
100003: 服务暂时不可用
100004: 数据库连接失败
100005: 第三方服务调用失败
100100: Token无效或已过期
100101: Token缺失
100102: 权限不足
100103: 账户被禁用
100104: 账户未激活
```

**用户相关错误码 (200000-299999)**:
```
200000: 用户不存在
200001: 用户名或密码错误
200002: 用户已存在
200003: 用户账户被锁定
200004: 用户信息不完整
200005: 手机号格式错误
200006: 邮箱格式错误
```

**订单相关错误码 (300000-399999)**:
```
300000: ��单不存在
300001: 订单状态不允许此操作
300002: 订单已取消
300003: 订单已支付
300004: 订单超时未支付
300005: 车辆不可用
300006: 取车时间无效
300007: 还车时间无效
300008: 订单金额计算错误
```

**支付相关错误码 (400000-499999)**:
```
400000: 支付失败
400001: 支付超时
400002: 支付金额无效
400003: 支付方式不支持
400004: 余额不足
400005: 支付渠道异常
400006: 退款失败
400007: 退款金额超限
```

**车辆相关错误码 (500000-599999)**:
```
500000: 车辆不存在
500001: 车辆已被租���
500002: 车辆维护中
500003: 车辆信息不完整
500004: 车辆位置无效
500005: 车辆型号不存在
```

**文件上传错误码 (600000-699999)**:
```
600000: 文件上传失败
600001: 文件格式不支持
600002: 文件大小超限
600003: 文件存储空间不足
600004: 文件类型不安全
```

#### 错误处理最佳实践

1. **统一错误响应格式**: 所有错误都按照标准格式返回
2. **详细错误信息**: 提供具体的错误原因和解决建议
3. **错误日志记录**: 所有错误都要记录日志，包含requestId
4. **用户友好提示**: 对用户显示友好的错误提示信息
5. **开发调试信息**: 在开发环境提供详细的堆栈信息

### 4.7 微信小程序特殊配置
- **域名白名单**: 配置 `https://api.daodaorv.com` 到微信公众平台
- **无Cookie支持**: 认证信息通过Header传递
- **请求限制**: 遵守微信小程序并发和频率限制
- **HTTPS强制**: 所有请求必须使用HTTPS协议

---

## 5. 核心业务规则技术实现

### 5.1 订单状态流转

**状态定义**:
```
待支付 → 待确认 → 管理端确认 → 待取车 → 使用中 → 待还车 → 已完成
         ↓           ↓              ↓
      已取消    已取消（取车前）  已取消（取车前）
```

**技术实现**:
- **后端**: 原生SQL + 状态机模式
  - 状态枚举: 数据库 `order_status` 表
  - 状态转换验证: Express 中间件 `orderStatusValidator`
  - 状态变更日志: `order_status_log` 表
- **前端**: Vue 3 Composition API + 定时轮询
  - `orderStore.updateStatus()` 方法
  - `setInterval` 定时检查订单状态更新

### 5.2 押金支付与退还流程

**业务规则**:
- 下单时记录押金金额（不实际支付）
- 到店取车时，门店员工发起押金支付（二维码）
- 还车时，车辆押金立即退还，违章押金30天后退还

**技术实现**:
- **后端**:
  - 押金记录: `orders.deposit_amount` 字段
  - 支付发起: `POST /api/orders/{id}/deposit/pay` 生成支付二维码
  - 支付回调: 微信/支付宝支付回调处理
  - 自动退还: node-cron 定时任务检查30天到期押金
- **前端**:
  - 小程序: `uni.requestPayment()` 调用支付
  - 移动管理端: 生成二维码，用户扫码支付
  - 支付状态轮询: `setInterval` 检查支付状态

### 5.3 电子签署

**技术实现**:
- **后端**: 集成第三方电子签名服务（如法大大、e签宝）
  - 签署记录: `contract_signs` 表
- **前端**: `uni.chooseImage()` 上传签名图片或调用第三方SDK

### 5.4 数据同步机制

**业务规则**: 定时同步，失败重新同步（最多3次），冲突以管理端数据为准

**技术实现**:
- **后端**:
  - Server-Sent Events: 推送重要状态变更
  - 定时同步: node-cron 每小时检查数据一致性
  - 重试机制: 失败任务自动重试，最多3次
- **前端**:
  - 离线存储: uni.setStorageSync 存储离线数据
  - 同步策略: 网络恢复时自动同步离线数据

### 5.5 分润规则

**业务规则**:
- 统一归集至管理端分润管理模块
- 订单完成时计算分润
- 次月5号发放分润
- 异常订单提交管理员手工确认

**技术实现**:
- **后端**:
  - 分润计算: 订单完成时触发 `calculateProfit()` 方法
  - 分润配置: `profit_configs` 表存储分润比例
  - 定时任务: node-cron 每月5号执行 `distributeProfit()` 发放分润
  - 异常处理: `profit_exceptions` 表记录异常订单

### 5.6 后端架构实现

#### Express.js 应用结构
```
backend/
├── src/
│   ├── app.ts              # 应用入口
│   ├── config/
│   │   ├── database.ts     # 数据库配置
│   │   └── jwt.ts          # JWT配置
│   ├── middleware/
│   │   ├── auth.ts         # 认证中间件
│   │   ├── permission.ts   # 权限中间件
│   │   └── validation.ts   # 数据验证中间件
│   ├── routes/
│   │   ├── auth.ts         # 认证路由
│   │   ├── users.ts        # 用户路由
│   │   ├── vehicles.ts     # 车辆路由
│   │   ├── orders.ts       # 订单路由
│   │   ├── payments.ts     # 支付路由
│   │   └── content.ts      # 内容路由
│   ├── controllers/
│   │   ├── OrderController.ts
│   │   ├── UserController.ts
│   │   └── PaymentController.ts
│   ├── models/
│   │   ├── Order.ts        # 数据模型
│   │   ├── User.ts
│   │   └── Vehicle.ts
│   └── utils/
│       ├── response.ts     # 统一响应格式
│       ├── validator.ts    # 数据验证工具
│       └── logger.ts       # 日志工具
```

#### 权限中间件实现
```typescript
// middleware/auth.ts
import jwt from 'jsonwebtoken';

const authenticateToken = (req: Request, res: Response, next: NextFunction) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.status(401).json({
      code: 401,
      message: '缺少认证token'
    });
  }

  jwt.verify(token, process.env.JWT_SECRET, (err, user) => {
    if (err) {
      return res.status(401).json({
        code: 401,
        message: 'token无效或已过期'
      });
    }
    req.user = user;
    next();
  });
};

const checkPermission = (requiredPermissions) => {
  return (req, res, next) => {
    const { userType, permissions, storeId } = req.user;

    // 检查用户是否有所需权限
    const hasPermission = requiredPermissions.every(perm =>
      permissions.includes(perm)
    );

    if (!hasPermission) {
      return res.status(403).json({
        code: 403,
        message: '权限不足'
      });
    }

    next();
  };
};

module.exports = { authenticateToken, checkPermission };
```

### 5.7 数据访问控制实现

#### 订单数据权限控制示例
```javascript
// controllers/OrderController.js
class OrderController {
  async getOrders(req, res) {
    const { userType, userId, storeId, permissions } = req.user;
    const { page = 1, pageSize = 20, status } = req.query;

    let whereClause = '1=1';
    const params = [];

    // 根据用户类型构建查询条件
    switch (userType) {
      case 'customer':
        whereClause += ' AND user_id = ?';
        params.push(userId);
        break;
      case 'mobile_admin':
        whereClause += ' AND store_id = ?';
        params.push(storeId);
        break;
      case 'pc_admin':
        if (permissions.includes('order:read:all')) {
          // 管理员可以查看所有订单
        } else if (permissions.includes('order:read:store')) {
          whereClause += ' AND store_id = ?';
          params.push(storeId);
        } else if (permissions.includes('order:read:region')) {
          // 区域管理员查看区域内订单
          whereClause += ' AND region_id = ?';
          params.push(req.user.regionId);
        }
        break;
    }

    // 状态筛选
    if (status) {
      whereClause += ' AND status = ?';
      params.push(status);
    }

    // 分页
    const offset = (page - 1) * pageSize;

    try {
      const [orders] = await db.query(`
        SELECT o.*, u.username as user_name, v.license_plate
        FROM orders o
        LEFT JOIN users u ON o.user_id = u.id
        LEFT JOIN vehicles v ON o.vehicle_id = v.id
        WHERE ${whereClause}
        ORDER BY o.created_at DESC
        LIMIT ? OFFSET ?
      `, [...params, parseInt(pageSize), offset]);

      const [countResult] = await db.query(`
        SELECT COUNT(*) as total FROM orders WHERE ${whereClause}
      `, params);

      res.json({
        code: 0,
        message: 'OK',
        data: orders,
        pagination: {
          page: parseInt(page),
          pageSize: parseInt(pageSize),
          total: countResult[0].total,
          pages: Math.ceil(countResult[0].total / pageSize)
        }
      });
    } catch (error) {
      res.status(500).json({
        code: 500,
        message: '查询订单失败',
        details: error.message
      });
    }
  }

  async createOrder(req, res) {
    // 只有C端用户可以创建订单
    if (req.user.userType !== 'customer') {
      return res.status(403).json({
        code: 403,
        message: '只有用户可以创建订单'
      });
    }

    const { vehicleId, startDate, endDate } = req.body;

    try {
      // 创建订单逻辑
      const orderId = await db.query(`
        INSERT INTO orders (user_id, vehicle_id, start_date, end_date, status, created_at)
        VALUES (?, ?, ?, ?, 'pending', NOW())
      `, [req.user.userId, vehicleId, startDate, endDate]);

      res.json({
        code: 0,
        message: '订单创建成功',
        data: { orderId: orderId.insertId }
      });
    } catch (error) {
      res.status(500).json({
        code: 500,
        message: '创建订单失败',
        details: error.message
      });
    }
  }
}
```

### 5.8 前端请求封装

#### 小程序端请求封装
```javascript
// utils/api.ts (小程序端和移动管理端通用)
class ApiClient {
  constructor() {
    this.baseURL = 'https://api.daodaorv.com/api/v1';
    this.token = wx.getStorageSync('token');
  }

  request(options) {
    return new Promise((resolve, reject) => {
      wx.request({
        url: `${this.baseURL}${options.url}`,
        method: options.method || 'GET',
        header: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.token}`,
          ...options.header
        },
        data: options.data,
        success: (res) => {
          if (res.data.code === 0) {
            resolve(res.data);
          } else {
            this.handleError(res.data);
            reject(res.data);
          }
        },
        fail: (error) => {
          wx.showToast({
            title: '网络请求失败',
            icon: 'none'
          });
          reject(error);
        }
      });
    });
  }

  handleError(error) {
    switch(error.code) {
      case 401:
        // Token过期，跳转登录
        wx.removeStorageSync('token');
        wx.navigateTo({ url: '/pages/login/index' });
        break;
      case 403:
        wx.showToast({ title: '权限不足', icon: 'none' });
        break;
      default:
        wx.showToast({
          title: error.message || '请求失败',
          icon: 'none'
        });
    }
  }

  // 用户端API
  getOrders(params) {
    return this.request({
      url: '/orders',
      data: params
    });
  }

  createOrder(orderData) {
    return this.request({
      url: '/orders',
      method: 'POST',
      data: orderData
    });
  }
}

// 导出单例
const apiClient = new ApiClient();
module.exports = apiClient;
```

#### PC管理端请求封装
```javascript
// utils/api.ts (PC管理端)
class AdminApiClient {
  constructor() {
    this.baseURL = 'https://api.daodaorv.com/api/v1';
    this.token = localStorage.getItem('token');
  }

  async request(options) {
    const response = await fetch(`${this.baseURL}${options.url}`, {
      method: options.method || 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.token}`,
        ...options.headers
      },
      body: JSON.stringify(options.data)
    });

    const result = await response.json();

    if (result.code === 0) {
      return result;
    } else {
      this.handleError(result);
      throw result;
    }
  }

  handleError(error) {
    switch(error.code) {
      case 401:
        localStorage.removeItem('token');
        window.location.href = '/login';
        break;
      case 403:
        alert('权限不足');
        break;
      default:
        alert(error.message || '请求失败');
    }
  }

  // 管理端专用API
  getAllUsers(params) {
    return this.request({
      url: '/users',
      data: params
    });
  }

  getOrdersByStore(storeId, params) {
    return this.request({
      url: `/orders?store_id=${storeId}`,
      data: params
    });
  }
}

const adminApiClient = new AdminApiClient();
module.exports = adminApiClient;
```

---

## 6. 开发环境快速启动

### 6.1 环境要求
- **Node.js**: 18.x LTS
- **npm**: 9.x+
- **HBuilderX**: 3.8+ (小程序开发)
- **VS Code**: 1.80+ (PC管理端开发)
- **Docker**: 20.10+ (数据库服务)
- **微信开发者工具**: 最新版本

### 6.2 项目路径总览

```
daodao01-docs/
├── miniprogram/            # C端小程序 (HBuilderX开发)
├── admin-console/          # PC管理端 (VS Code开发)
├── mobile-admin/           # B端移动管理 (HBuilderX开发)
├── backend/                # 后端API (VS Code开发)
├── docker-compose.yml      # Docker数据库配置
├── Docs/                   # 项目文档
│   └── 技术栈与架构设计.md  # 本文档
├── 启动指南.md             # 快速启动指南
└── README.md               # 项目说明
```

### 6.3 快速启动步骤

#### **1. 启动数据库服务**
```bash
# 启动 MySQL 和 Redis
docker compose up -d mysql redis

# 检查服务状态
docker compose ps
```

#### **2. 启动后端服务**
```bash
cd backend
npm install
npm run dev
# 访问: http://localhost:3000/health
```

#### **3. 启动PC管理端**
```bash
cd admin-console
npm install
npm run dev
# 访问: http://localhost:5173
```

#### **4. 创建小程序项目 (HBuilderX)**
1. **打开 HBuilderX**
2. **文件 → 导入 → 从本地目录导入**
3. **选择 `miniprogram/` 目录**
4. **选择 uni-app 项目模板**
5. **运行 → 运行到小程序模拟器 → 微信开发者工具**

#### **5. 创建移动管理项目 (HBuilderX)**
1. **同样步骤导入 `mobile-admin/` 目录**
2. **创建管理端项目**
3. **运行到微信开发者工具**

### 6.4 开发分工明确

| 开发者 | 负责模块 | 开发工具 | 项目路径 |
|--------|----------|----------|----------|
| **您** | miniprogram (小程序端) | HBuilderX | `miniprogram/` |
| **您** | mobile-admin (移动管理) | HBuilderX | `mobile-admin/` |
| **我** | admin-console (PC管理端) | VS Code | `admin-console/` |
| **我** | backend (后端API) | VS Code | `backend/` |

### 6.5 重要配置文件

#### **后端环境变量** (`backend/.env`)
```env
# 数据库配置 (Docker)
DB_HOST=localhost
DB_PORT=3306
DB_NAME=daodao
DB_USER=daodao_dev
DB_PASSWORD=daodao_dev_2024

# 服务配置
PORT=3000
NODE_ENV=development

# JWT配置
JWT_SECRET=daodao_jwt_secret_key_2024_daodao_project
```

#### **Docker配置** (`docker-compose.yml`)
```yaml
services:
  mysql:
    ports:
      - "3306:3306"
  redis:
    ports:
      - "6379:6379"
```

### 6.6 调试端口分配

| 服务 | 端口 | 用途 |
|------|------|------|
| 后端API | 3000 | Express服务 |
| PC管理端 | 5173 | Vite开发服务器 |
| MySQL | 3306 | 数据库服务 |
| Redis | 6379 | 缓存服务 |
| Adminer | 8080 | 数据库管理工具 |

### 6.7 常见问题排除

#### **端口冲突检查**
```bash
# 检查端口占用
netstat -an | grep :3000
netstat -an | grep :5173
```

#### **Docker服务问题**
```bash
# 重启数据库服务
docker compose restart mysql redis

# 查看服务日志
docker compose logs mysql
docker compose logs redis
```

#### **前端编译问题**
- **小程序端**: 确保HBuilderX和微信开发者工具配置正确
- **PC管理端**: 检查Node.js版本和依赖安装

> 项目开发完成后将补充详细的开发环境配置文档

---

## 版本变更记录

### v5.0 (2025-11-12)

#### 🔄 主要更新
- **统一技术栈版本号**: 将所有模糊版本号更新为具体版本号
  - Vue: 3.5+ → 3.5.0
  - uni-app: 3.x → 3.0.0
  - Node.js: 18.x LTS → 18.18.0 LTS
  - MySQL: 8.0+ → 8.0.35
  - Redis: 7.0+ → 7.2.3
  - 以及其他所有依赖组件的具体版本号

- **标准化API响应格式**: 完善统一响应格式标准
  - 新增验证错误响应格式
  - 统一错误信息结构
  - 规范分页响应格式

- **完善错误码体系**: 建立完整的错误码标准
  - HTTP状态码规范
  - 业务错误码分类体系
  - 错误处理最佳实践

- **新增依赖版本**: 补充完整的依赖版本信息
  - 新增TypeScript版本规范
  - 新增Vite构建工具版本
  - 新增所有npm包的具体版本

#### 🐛 修正内容
- 修正版本号不一致问题
- 修复文档中的格式错误
- 统一术语和表述方式

#### ⚠️ 重要提示
- 本版本统一了所有技术栈版本号，请按照具体版本号安装依赖
- API响应格式有更新，前端需要适配新的响应结构
- 错误码体系重新设计，需要更新错误处理逻辑

---

### v4.0 (2025-11-10)
#### 🆕 初始版本
- 建立技术栈架构设计文档框架
- 定义各端技术栈规范
- 制定API设计规范
- 完善开发环境配置

---

**文档维护**: 叨叨房车技术团队
**最后更新**: 2025-11-12
**版本**: v5.0
**下次审核**: 2025-12-12