# 项目任务分解规划

## 小程序首页和房车预订模块优化

**文档版本**: v1.0
**创建时间**: 2025-11-22
**维护者**: 叨叨房车技术团队

---

## 已明确的决策

- **技术栈**: uni-app 3.0.0 + Vue 3.5.0 + TypeScript 5.1.6
- **UI组件库**: uView Plus + 自定义组件（BaseCard、BaseButton、BasePopup等）
- **设计规范**: 遵循《小程序UI设计指南.md》，主色调 #FF9F29（橙色），会员主题 #8860D0（紫色）
- **开发模式**: 组件化开发，复用现有基础组件和业务组件
- **数据管理**: Vue 3 Composition API + Pinia 状态管理

---

## 整体规划概述

### 项目目标

1. **完善房车预订核心功能**：实现门店选择器、日期选择器、时间选择器的完整交互
2. **优化首页UI布局**：修复营销活动区布局问题，优化推荐内容区标签切换样式
3. **提升用户体验**：增加用户位置定位、公告轮播切换、表单验证反馈
4. **代码质量提升**：复用现有组件，减少重复代码，统一设计规范

### 技术栈

- **前端框架**: uni-app 3.0.0 + Vue 3.5.0 (Composition API)
- **类型系统**: TypeScript 5.1.6
- **UI组件库**: uView Plus + 自定义基础组件
- **状态管理**: Pinia
- **样式方案**: SCSS + CSS变量

### 主要阶段

1. **阶段一: 房车预订组件核心功能实现**（预计 3-4 天）
   - 门店选择器完整实现
   - 日期选择器完整实现
   - 时间选择器完整实现
   - 表单验证逻辑完善

2. **阶段二: 首页UI优化与布局修复**（预计 2 天）
   - 营销活动区布局重构
   - 推荐内容区标签切换优化
   - 公告栏多条轮播实现
   - 响应式设计优化

3. **阶段三: 功能增强与集成测试**（预计 2 天）
   - 用户位置定位功能
   - 城市数据API集成
   - 门店数据API集成
   - 端到端功能测试

---

## 详细任务分解

### 阶段一: 房车预订组件核心功能实现

#### 任务 1.1: 门店选择器组件实现

- **目标**: 实现完整的门店选择功能，支持根据城市加载门店列表、搜索和定位
- **输入**: 用户选择的城市、用户当前位置（可选）
- **输出**: 选中的门店信息（名称、地址、距离、营业时间）
- **涉及文件**:
  - `miniprogram/components/form/StoreSelector.vue`（新建）
  - `miniprogram/components/business/vehicle/VehicleBooking.vue`（修改）
  - `miniprogram/api/store.js`（新建）
  - `miniprogram/types/store.d.ts`（新建）
- **预估工作量**: 8小时

**实现要点**:
1. 创建 StoreSelector 组件，基于 BasePopup 实现底部弹窗
2. 门店列表按距离排序，显示门店名称、地址、距离、营业时间
3. 支持门店搜索（名称、地址关键词）
4. 支持"附近门店"快速筛选（需用户授权位置）
5. 门店选中后触发 `@select` 事件，返回门店完整信息

**UI设计要点**:
- 弹窗标题: "选择取车门店" / "选择还车门店"
- 门店卡片: 橙色图标 + 门店名称 + 地址 + 距离标签 + 营业时间
- 空状态: 显示"该城市暂无门店"提示
- 加载状态: 使用 BaseLoading 组件

---

#### 任务 1.2: 日期选择器集成与优化

- **目标**: 将现有 DateTimePicker 组件集成到 VehicleBooking，实现日期选择功能
- **输入**: 当前日期、最小可选日期（今天）、最大可选日期（30天后）
- **输出**: 选中的取车/还车日期
- **涉及文件**:
  - `miniprogram/components/business/vehicle/VehicleBooking.vue`（修改）
  - `miniprogram/components/form/DateTimePicker.vue`（优化）
- **预估工作量**: 4小时

**实现要点**:
1. 复用现有 DateTimePicker 组件的日期选择部分
2. 日期范围限制: 最早可选今天，最晚可选30天后
3. 取车日期选择后，自动限制还车日期不能早于取车日期
4. 选中日期后自动关闭弹窗并更新表单

**业务规则**:
- 取车日期 >= 今天
- 还车日期 > 取车日期
- 最长租期 30 天

---

#### 任务 1.3: 时间选择器实现

- **目标**: 实现门店营业时间范围内的时间选择功能
- **输入**: 门店营业时间（默认 08:00-20:00）、已选日期
- **输出**: 选中的取车/还车时间（格式 HH:mm）
- **涉及文件**:
  - `miniprogram/components/form/TimePicker.vue`（新建）
  - `miniprogram/components/business/vehicle/VehicleBooking.vue`（修改）
- **预估工作量**: 4小时

**实现要点**:
1. 创建独立的 TimePicker 组件，基于 BasePopup 实现
2. 时间选项: 30分钟间隔（08:00, 08:30, 09:00...）
3. 营业时间限制: 只显示门店营业时间内的时间段
4. 当日取车: 只显示当前时间 2 小时后的时间段
5. 滚动选择器样式，类似微信原生时间选择器

**UI设计要点**:
- 双列滚动: 小时列 + 分钟列
- 选中态: 橙色高亮 + 放大效果
- 快捷选项: "上午（08:00-12:00）"、"下午（14:00-18:00）"

---

#### 任务 1.4: VehicleBooking 组件重构与集成

- **目标**: 将门店选择器、日期选择器、时间选择器集成到预订表单
- **输入**: 用户输入的各项预订信息
- **输出**: 完整的预订表单数据、表单验证状态
- **涉及文件**:
  - `miniprogram/components/business/vehicle/VehicleBooking.vue`（重构）
- **预估工作量**: 6小时

**重构要点**:
1. 替换 console.log 占位符为实际选择器调用
2. 实现门店选择器弹窗触发逻辑
3. 实现日期选择器弹窗触发逻辑
4. 实现时间选择器弹窗触发逻辑
5. 完善还车城市选择逻辑（复用城市选择器）

**表单验证规则**:
- 取车城市: 必填
- 取车门店: 必填
- 取车日期: 必填，不能早于今天
- 取车时间: 必填，当日需至少提前2小时
- 还车日期: 必填，不能早于取车日期
- 还车时间: 必填
- 异地还车时: 还车城市和还车门店必填

---

#### 任务 1.5: 异地还车费用提示实现

- **目标**: 当用户选择异地还车时，显示费用提醒
- **输入**: 取车城市、还车城市
- **输出**: 异地还车费用提示信息
- **涉及文件**:
  - `miniprogram/components/business/vehicle/VehicleBooking.vue`（修改）
  - `miniprogram/api/store.js`（添加费用查询接口）
- **预估工作量**: 2小时

**实现要点**:
1. 勾选"异地还车"时显示提示: "异地还车将产生额外费用"
2. 选择还车城市后，调用接口查询异地还车费用
3. 费用显示格式: "异地还车费: xxx元"
4. 费用详情在订单确认页显示

---

### 阶段二: 首页UI优化与布局修复

#### 任务 2.1: 营销活动区布局重构

- **目标**: 修复营销活动区的布局问题，实现橙色渐变+紫色渐变卡片效果
- **输入**: 设计规范（领券中心橙色、PLUS会员紫色）
- **输出**: 符合设计规范的营销活动区布局
- **涉及文件**:
  - `miniprogram/pages/home/index.vue`（修改样式部分）
- **预估工作量**: 3小时

**UI设计要点（参考设计指南）**:
```scss
// 领券中心卡片
.coupon-card {
  background: linear-gradient(135deg, #FF9F29 0%, #FFB833 100%);
  color: #FFFFFF;
}

// PLUS会员卡片
.vip-card {
  background: linear-gradient(135deg, #8860D0 0%, #A78BDB 100%);
  color: #FFFFFF;
}
```

**布局修复**:
1. 使用 `display: grid; grid-template-columns: 1fr 1fr; gap: 16rpx;` 替代独立margin
2. 统一卡片高度和内边距
3. 添加卡片阴影和圆角效果

---

#### 任务 2.2: 推荐内容区标签切换优化

- **目标**: 优化标签切换样式，符合设计规范
- **输入**: 当前选中标签状态
- **输出**: 符合设计的标签切换效果
- **涉及文件**:
  - `miniprogram/pages/home/index.vue`（修改样式部分）
- **预估工作量**: 2小时

**UI设计要点**:
1. 标签容器: 浅灰背景 (#F7F8FA)，圆角 12rpx
2. 选中态: 橙色背景 (#FF9F29)，白色文字，轻微阴影
3. 未选中态: 透明背景，灰色文字 (#667085)
4. 切换动画: 0.3s ease 过渡效果

---

#### 任务 2.3: 公告栏多条轮播实现

- **目标**: 实现多条公告的轮播切换功能
- **输入**: 公告列表数据（标题、链接、类型）
- **输出**: 可轮播的公告栏组件
- **涉及文件**:
  - `miniprogram/pages/home/index.vue`（修改）
  - `miniprogram/api/notice.js`（新建）
- **预估工作量**: 2小时

**实现要点**:
1. 使用 swiper 组件实现垂直方向轮播
2. 轮播间隔: 4秒
3. 支持点击跳转公告详情
4. 公告类型区分: 活动（橙色图标）、系统（蓝色图标）、紧急（红色图标）

---

#### 任务 2.4: 快捷服务区响应式优化

- **目标**: 优化金刚区在不同屏幕宽度下的布局表现
- **输入**: 设备屏幕宽度
- **输出**: 自适应的金刚区布局
- **涉及文件**:
  - `miniprogram/pages/home/index.vue`（修改样式部分）
- **预估工作量**: 1小时

**响应式规则**:
- 标准屏幕（>= 750rpx）: 3列布局
- 窄屏幕（< 750rpx）: 保持3列，减小间距和图标尺寸
- 建议移除窄屏下切换为2列的逻辑，保持一致性

---

### 阶段三: 功能增强与集成测试

#### 任务 3.1: 用户位置定位功能

- **目标**: 首次进入首页时自动获取用户位置，智能推荐附近城市
- **输入**: 用户授权的位置信息
- **输出**: 用户当前城市、附近门店列表
- **涉及文件**:
  - `miniprogram/utils/location.js`（新建）
  - `miniprogram/pages/home/index.vue`（修改）
  - `miniprogram/components/business/vehicle/VehicleBooking.vue`（修改）
- **预估工作量**: 4小时

**实现要点**:
1. 使用 `uni.getLocation` 获取用户坐标
2. 调用腾讯/高德地图逆地理编码接口获取城市名称
3. 如果用户未授权，使用默认城市（北京）
4. 定位成功后自动填充取车城市
5. 提供"重新定位"入口

**权限处理**:
- 首次请求: 显示授权提示弹窗
- 拒绝授权: 引导用户手动选择城市
- 授权失败: 静默处理，不影响用户体验

---

#### 任务 3.2: 城市数据API集成

- **目标**: 将硬编码的城市数据替换为API获取
- **输入**: API接口地址
- **输出**: 动态的城市列表（支持热门城市、字母分组）
- **涉及文件**:
  - `miniprogram/api/city.js`（新建）
  - `miniprogram/components/business/vehicle/VehicleBooking.vue`（修改）
  - `miniprogram/stores/city.js`（新建）
- **预估工作量**: 3小时

**数据结构**:
```typescript
interface City {
  code: string;        // 城市编码
  name: string;        // 城市名称
  fullName: string;    // 完整名称（省市）
  pinyin: string;      // 拼音
  letter: string;      // 首字母
  isHot: boolean;      // 是否热门
  hasStores: boolean;  // 是否有门店
}
```

**缓存策略**:
- 城市列表本地缓存，有效期 24 小时
- 使用 Pinia 管理城市数据状态

---

#### 任务 3.3: 门店数据API集成

- **目标**: 实现门店列表API调用，支持按城市、距离筛选
- **输入**: 城市编码、用户坐标（可选）
- **输出**: 门店列表（按距离排序）
- **涉及文件**:
  - `miniprogram/api/store.js`（完善）
  - `miniprogram/stores/store.js`（新建）
- **预估工作量**: 3小时

**数据结构**:
```typescript
interface Store {
  id: string;            // 门店ID
  code: string;          // 门店编码
  name: string;          // 门店名称
  cityCode: string;      // 所属城市
  address: string;       // 详细地址
  phone: string;         // 联系电话
  businessHours: string; // 营业时间（如 "08:00-20:00"）
  latitude: number;      // 纬度
  longitude: number;     // 经度
  distance?: number;     // 距用户距离（米）
  supportDiffReturn: boolean; // 是否支持异地还车
}
```

---

#### 任务 3.4: 端到端功能测试

- **目标**: 验证首页和房车预订模块的完整用户流程
- **输入**: 测试用例
- **输出**: 测试报告、Bug列表
- **涉及文件**: 无（测试工作）
- **预估工作量**: 4小时

**测试场景**:
1. **首页加载测试**
   - 公告栏显示和轮播
   - Banner轮播和点击跳转
   - 金刚区图标和点击跳转
   - 营销活动区显示和点击

2. **房车预订流程测试**
   - 城市选择（定位、搜索、热门城市）
   - 门店选择（列表加载、搜索、距离排序）
   - 日期选择（日期范围限制、快捷选择）
   - 时间选择（营业时间限制）
   - 异地还车（费用提示）
   - 表单验证（必填项、时间逻辑）
   - 查询按钮（禁用状态、加载状态）

3. **异常场景测试**
   - 网络异常处理
   - 空数据展示
   - 权限拒绝处理

---

## 需要进一步明确的问题

### 问题 1: 门店数据来源

**背景**: 当前门店数据是硬编码的，需要确定实际数据来源

**推荐方案**:

- 方案 A: 后端API直接返回门店列表
  - 优点: 数据实时、支持动态管理
  - 缺点: 依赖后端开发进度

- 方案 B: 先使用本地JSON数据，后续接入API
  - 优点: 前端可独立开发
  - 缺点: 需要二次集成工作

**等待用户选择**:

```
请选择您偏好的方案，或提供其他建议：
[ ] 方案 A: 后端API直接返回
[ ] 方案 B: 先本地JSON数据
[ ] 其他方案：_________________
```

---

### 问题 2: 位置定位服务提供商

**背景**: 逆地理编码需要使用地图服务商的API

**推荐方案**:

- 方案 A: 腾讯位置服务
  - 优点: 与微信生态集成好，免费额度高（10000次/日）
  - 缺点: 需要申请密钥

- 方案 B: 高德地图API
  - 优点: 文档完善，稳定性好
  - 缺点: 免费额度较低（5000次/日）

- 方案 C: 不使用逆地理编码，仅获取坐标后匹配最近城市
  - 优点: 无第三方依赖
  - 缺点: 城市匹配精度较低

**等待用户选择**:

```
请选择您偏好的方案，或提供其他建议：
[ ] 方案 A: 腾讯位置服务
[ ] 方案 B: 高德地图API
[ ] 方案 C: 坐标匹配最近城市
[ ] 其他方案：_________________
```

---

### 问题 3: 异地还车费用计算规则

**背景**: 异地还车需要显示费用，需要确定计算规则

**推荐方案**:

- 方案 A: 固定费用（如统一500元）
  - 优点: 实现简单，用户理解成本低
  - 缺点: 不够灵活

- 方案 B: 按城市距离计算（如每公里1元）
  - 优点: 更加公平合理
  - 缺点: 需要维护城市距离矩阵

- 方案 C: 后端配置城市间费用表
  - 优点: 灵活可配置
  - 缺点: 配置工作量大

**等待用户选择**:

```
请选择您偏好的方案，或提供其他建议：
[ ] 方案 A: 固定费用
[ ] 方案 B: 按距离计算
[ ] 方案 C: 后端配置费用表
[ ] 其他方案：_________________
```

---

### 问题 4: DateTimePicker 组件复用策略

**背景**: 项目中已存在 DateTimePicker 组件，功能完善但与 VehicleBooking 集成需要调整

**推荐方案**:

- 方案 A: 直接在 VehicleBooking 中引入 DateTimePicker 组件
  - 优点: 代码复用最大化
  - 缺点: DateTimePicker 组件较重，包含很多不需要的功能

- 方案 B: 提取 DateTimePicker 的日期/时间选择部分为独立子组件
  - 优点: 更轻量，职责单一
  - 缺点: 需要额外拆分工作

- 方案 C: 使用 uni-app 原生日期时间选择器
  - 优点: 无需维护自定义组件
  - 缺点: 样式定制受限

**等待用户选择**:

```
请选择您偏好的方案，或提供其他建议：
[ ] 方案 A: 直接引入完整组件
[ ] 方案 B: 拆分为独立子组件
[ ] 方案 C: 使用原生选择器
[ ] 其他方案：_________________
```

---

## 风险评估

### 技术风险

| 风险项 | 风险等级 | 影响范围 | 缓解措施 |
|--------|----------|----------|----------|
| BasePopup 组件兼容性 | 中 | 所有弹窗功能 | 提前测试，必要时切换为 uni-popup |
| 位置授权用户拒绝率高 | 中 | 定位功能 | 提供手动选择城市的备选方案 |
| 城市/门店数据量大导致性能问题 | 低 | 选择器加载 | 使用虚拟列表、分页加载 |
| 时间选择器在不同机型表现不一致 | 低 | 时间选择功能 | 多机型测试，使用 scroll-view 实现 |

### 进度风险

| 风险项 | 风险等级 | 影响范围 | 缓解措施 |
|--------|----------|----------|----------|
| 后端API未就绪 | 高 | API集成任务 | 使用Mock数据先行开发，后续对接 |
| 设计稿细节确认延迟 | 中 | UI开发任务 | 基于设计指南先行开发，后续微调 |
| 测试资源不足 | 低 | 测试任务 | 开发自测 + 自动化测试补充 |

---

## 验收标准

### 功能验收

- [ ] 城市选择器正常工作（搜索、热门城市、字母索引）
- [ ] 门店选择器正常工作（列表加载、搜索、距离排序）
- [ ] 日期选择器正常工作（日期范围限制、选中效果）
- [ ] 时间选择器正常工作（营业时间限制、30分钟间隔）
- [ ] 异地还车功能正常（城市切换、费用提示）
- [ ] 表单验证完整（必填项、时间逻辑）
- [ ] 查询按钮状态正确（禁用态、加载态）
- [ ] 首页公告栏轮播正常
- [ ] 营销活动区布局正确
- [ ] 推荐内容区标签切换正常

### UI验收

- [ ] 颜色符合设计规范（主色 #FF9F29、会员紫 #8860D0）
- [ ] 间距符合设计规范（页面边距 24rpx、组件间距 16-32rpx）
- [ ] 圆角符合设计规范（小 8rpx、中 16rpx、大 24rpx）
- [ ] 响应式布局在不同屏幕尺寸下正常显示
- [ ] 交互反馈及时（点击态、加载态、成功/失败提示）

### 性能验收

- [ ] 首页加载时间 < 3秒
- [ ] 选择器弹窗打开时间 < 500ms
- [ ] 城市/门店列表滚动流畅（60fps）
- [ ] 无明显内存泄漏

---

## 用户反馈区域

请在此区域补充您对整体规划的意见和建议：

```
用户补充内容：

_______________________________________________

_______________________________________________

_______________________________________________

```

---

## 附录

### A. 现有可复用组件清单

| 组件名称 | 路径 | 用途 | 状态 |
|----------|------|------|------|
| BaseCard | `components/base/BaseCard.vue` | 卡片容器 | 可直接使用 |
| BaseButton | `components/base/BaseButton.vue` | 按钮 | 可直接使用 |
| BasePopup | `components/base/BasePopup.vue` | 弹窗 | 可直接使用 |
| BaseEmpty | `components/base/BaseEmpty.vue` | 空状态 | 可直接使用 |
| BaseLoading | `components/base/BaseLoading.vue` | 加载状态 | 可直接使用 |
| CitySelector | `components/form/CitySelector.vue` | 城市选择 | 功能完善，可复用 |
| DateTimePicker | `components/form/DateTimePicker.vue` | 日期时间选择 | 功能完善，需集成 |

### B. 设计规范速查

```scss
// 主色系统
$primary-orange: #FF9F29;     // 主色调
$member-purple: #8860D0;      // 会员主题
$success-green: #67C23A;      // 成功色
$info-blue: #4B91FF;          // 信息色
$error-red: #FF4D4F;          // 错误色

// 文字颜色
$text-primary: rgba(0, 0, 0, 0.9);   // 主要文字
$text-secondary: rgba(0, 0, 0, 0.6); // 次要文字
$text-tertiary: rgba(0, 0, 0, 0.4);  // 辅助文字

// 背景颜色
$bg-page: #F7F8FA;     // 页面背景
$bg-card: #FFFFFF;     // 卡片背景

// 间距
$spacing-sm: 16rpx;    // 小间距
$spacing-md: 24rpx;    // 中间距
$spacing-lg: 32rpx;    // 大间距

// 圆角
$radius-sm: 8rpx;      // 小圆角
$radius-md: 16rpx;     // 中圆角
$radius-lg: 24rpx;     // 大圆角
```

---

**文档维护**: 叨叨房车技术团队
**最后更新**: 2025-11-22
**版本**: v1.0
