# 叨叨房车管理端测试策略文档

**文档版本**: v1.0 | **创建时间**: 2024-11-24 | **更新时间**: 2024-11-24

---

## 1. 测试策略概述

### 1.1 测试目标

- **功能正确性**: 确保所有功能模块按照需求文档正确实现
- **用户体验**: 保证界面友好、响应及时、操作流畅
- **系统稳定性**: 确保系统在各种条件下稳定运行
- **安全可靠性**: 验证权限控制和数据安全机制
- **性能达标**: 满足性能要求和并发处理能力

### 1.2 测试范围

**功能测试范围**:
- 用户认证和权限管理
- 用户管理模块
- 车辆管理模块
- 门店管理模块
- 订单管理模块
- 众筹管理模块
- 营销管理模块
- 系统管理模块
- 财务管理模块

**非功能测试范围**:
- 性能测试
- 安全测试
- 兼容性测试
- 易用性测试
- 界面测试

### 1.3 测试原则

1. **测试驱动开发**: 先写测试用例，再实现功能
2. **全面覆盖**: 覆盖所有业务流程和边界条件
3. **自动化优先**: 优先实现自动化测试
4. **持续集成**: 集成到CI/CD流程中
5. **缺陷预防**: 通过测试及早发现和预防缺陷

---

## 2. 测试层级架构

### 2.1 测试金字塔

```
    /\
   /  \
  /E2E \       端到端测试 (10%)
 /______\
 /        \
/Integration\ 集成测试 (20%)
/____________\
/            \
/   Unit      \  单元测试 (70%)
/______________\
```

### 2.2 各层级职责

**单元测试 (Unit Testing)**:
- 测试单个函数、组件、模块的功能
- 快速反馈，开发阶段执行
- 覆盖率要求: >80%
- 工具: Vitest + Vue Test Utils

**集成测试 (Integration Testing)**:
- 测试模块间的交互和数据流
- API接口测试
- 组件集成测试
- 数据库交互测试
- 工具: Vitest + Supertest

**端到端测试 (E2E Testing)**:
- 模拟真实用户操作场景
- 完整业务流程验证
- 跨浏览器兼容性测试
- 工具: Playwright

---

## 3. 单元测试策略

### 3.1 组件测试

#### 测试框架配置

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config'
import vue from '@vitejs/plugin-vue'
import path from 'path'

export default defineConfig({
  plugins: [vue()],
  test: {
    environment: 'jsdom',
    globals: true,
    setupFiles: ['./tests/setup.ts']
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src')
    }
  }
})
```

#### 测试用例示例

```typescript
// tests/unit/components/DataTable.spec.ts
import { describe, it, expect, beforeEach } from 'vitest'
import { mount } from '@vue/test-utils'
import { nextTick } from 'vue'
import DataTable from '@/components/common/DataTable.vue'
import type { TableColumn } from '@/components/common/DataTable.vue'

describe('DataTable.vue', () => {
  const mockData = [
    { id: 1, name: '测试用户1', email: 'test1@example.com' },
    { id: 2, name: '测试用户2', email: 'test2@example.com' }
  ]

  const mockColumns: TableColumn[] = [
    { prop: 'id', label: 'ID', width: 80 },
    { prop: 'name', label: '姓名', width: 120 },
    { prop: 'email', label: '邮箱', width: 200 }
  ]

  it('should render table with correct data', () => {
    const wrapper = mount(DataTable, {
      props: {
        data: mockData,
        columns: mockColumns
      }
    })

    const rows = wrapper.findAll('.el-table__row')
    expect(rows).toHaveLength(2)

    // 检查第一行数据
    const firstRow = rows[0]
    const cells = firstRow.findAll('.el-table__cell')
    expect(cells[0].text()).toBe('1')
    expect(cells[1].text()).toBe('测试用户1')
    expect(cells[2].text()).toBe('test1@example.com')
  })

  it('should emit selection-change when selection changes', async () => {
    const wrapper = mount(DataTable, {
      props: {
        data: mockData,
        columns: mockColumns,
        selectable: true
      }
    })

    // 模拟选择操作
    const checkbox = wrapper.find('.el-checkbox__input')
    await checkbox.setValue(true)

    expect(wrapper.emitted('selection-change')).toBeTruthy()
    expect(wrapper.emitted('selection-change')![0]).toEqual([[mockData[0]]])
  })

  it('should render pagination when pagination prop is provided', () => {
    const pagination = {
      page: 1,
      size: 20,
      total: 100
    }

    const wrapper = mount(DataTable, {
      props: {
        data: mockData,
        columns: mockColumns,
        pagination,
        showPagination: true
      }
    })

    expect(wrapper.find('.el-pagination').exists()).toBe(true)
  })

  it('should handle empty data correctly', () => {
    const wrapper = mount(DataTable, {
      props: {
        data: [],
        columns: mockColumns
      }
    })

    expect(wrapper.find('.el-table__empty-block').exists()).toBe(true)
    expect(wrapper.text()).toContain('暂无数据')
  })
})
```

#### Composables测试

```typescript
// tests/unit/composables/usePermission.spec.ts
import { describe, it, expect, beforeEach } from 'vitest'
import { setActivePinia, createPinia } from 'pinia'
import { usePermissionStore } from '@/stores/permission'

describe('usePermission', () => {
  beforeEach(() => {
    setActivePinia(createPinia())
  })

  it('should check permission correctly', async () => {
    const store = usePermissionStore()

    // 模拟权限数据
    const permissions = [
      { code: 'user:view', type: 'button' },
      { code: 'user:create', type: 'button' }
    ]

    // 这里需要模拟权限验证逻辑
    // 实际实现中需要根据具体的权限系统来模拟

    expect(store.hasPermission('user:view')).toBe(true)
    expect(store.hasPermission('user:edit')).toBe(false)
    expect(store.hasPermission(['user:view', 'user:create'])).toBe(true)
  })
})
```

### 3.2 Store测试

```typescript
// tests/unit/stores/auth.spec.ts
import { describe, it, expect, beforeEach } from 'vitest'
import { setActivePinia, createPinia } from 'pinia'
import { useAuthStore } from '@/stores/auth'
import { authApi } from '@/api/auth'

// Mock API
vi.mock('@/api/auth')

describe('useAuthStore', () => {
  beforeEach(() => {
    setActivePinia(createPinia())
    vi.clearAllMocks()
  })

  it('should login successfully with valid credentials', async () => {
    const mockResponse = {
      data: {
        user: {
          id: '1',
          username: 'admin',
          name: '管理员',
          roles: [{ code: 'admin' }],
          permissions: [{ code: 'user:view' }]
        },
        token: 'mock-token',
        refreshToken: 'mock-refresh-token'
      }
    }

    vi.mocked(authApi.login).mockResolvedValue(mockResponse)

    const store = useAuthStore()
    await store.login({ username: 'admin', password: 'password' })

    expect(store.user).toEqual(mockResponse.data.user)
    expect(store.token).toBe('mock-token')
    expect(store.isAuthenticated).toBe(true)
    expect(authApi.login).toHaveBeenCalledWith({ username: 'admin', password: 'password' })
  })

  it('should clear user data on logout', async () => {
    const store = useAuthStore()

    // 先设置登录状态
    store.user = { id: '1', username: 'admin' } as any
    store.token = 'mock-token'

    await store.logout()

    expect(store.user).toBe(null)
    expect(store.token).toBe('')
    expect(store.isAuthenticated).toBe(false)
  })
})
```

### 3.3 工具函数测试

```typescript
// tests/unit/utils/format.spec.ts
import { describe, it, expect } from 'vitest'
import { formatDate, formatCurrency } from '@/utils/format'

describe('format utils', () => {
  it('should format date correctly', () => {
    const date = new Date('2024-11-24T10:00:00')
    expect(formatDate(date)).toBe('2024-11-24')
    expect(formatDate(date, 'YYYY-MM-DD HH:mm:ss')).toBe('2024-11-24 10:00:00')
  })

  it('should format currency correctly', () => {
    expect(formatCurrency(1234.56)).toBe('¥1,234.56')
    expect(formatCurrency(0)).toBe('¥0.00')
    expect(formatCurrency(1234, '$')).toBe('$1,234.00')
  })
})
```

---

## 4. 集成测试策略

### 4.1 API接口测试

#### 接口测试框架

```typescript
// tests/integration/api/users.spec.ts
import { describe, it, expect, beforeEach, afterEach } from 'vitest'
import request from 'supertest'
import app from '@/app'

describe('Users API', () => {
  let authToken: string

  beforeEach(async () => {
    // 登录获取token
    const response = await request(app)
      .post('/api/v1/auth/login')
      .send({
        username: 'admin',
        password: 'password'
      })

    authToken = response.body.data.token
  })

  afterEach(async () => {
    // 清理测试数据
  })

  it('should get user list with authentication', async () => {
    const response = await request(app)
      .get('/api/v1/users')
      .set('Authorization', `Bearer ${authToken}`)
      .expect(200)

    expect(response.body.code).toBe(0)
    expect(response.body.data).toBeInstanceOf(Array)
    expect(response.body.meta.pagination).toBeDefined()
  })

  it('should create user with valid data', async () => {
    const userData = {
      username: 'newuser',
      name: '新用户',
      email: 'newuser@example.com',
      password: 'password123'
    }

    const response = await request(app)
      .post('/api/v1/users')
      .set('Authorization', `Bearer ${authToken}`)
      .send(userData)
      .expect(200)

    expect(response.body.code).toBe(0)
    expect(response.body.data.username).toBe(userData.username)
    expect(response.body.data.password).toBeUndefined() // 密码不应该返回
  })

  it('should return 401 for unauthorized request', async () => {
    const response = await request(app)
      .get('/api/v1/users')
      .expect(401)

    expect(response.body.code).not.toBe(0)
  })

  it('should return 403 for insufficient permissions', async () => {
    // 使用没有权限的用户token
    const userToken = await getUserToken('user_without_permission')

    const response = await request(app)
      .post('/api/v1/users')
      .set('Authorization', `Bearer ${userToken}`)
      .send({
        username: 'test',
        name: 'Test User'
      })
      .expect(403)

    expect(response.body.code).not.toBe(0)
  })
})
```

### 4.2 数据库测试

```typescript
// tests/integration/database/user.spec.ts
import { describe, it, expect, beforeEach, afterEach } from 'vitest'
import { getRepository } from 'typeorm'
import { User } from '@/models/User'

describe('User Database Operations', () => {
  let userRepository: any

  beforeEach(async () => {
    userRepository = getRepository(User)
  })

  afterEach(async () => {
    await userRepository.clear()
  })

  it('should create user in database', async () => {
    const userData = {
      username: 'testuser',
      name: 'Test User',
      email: 'test@example.com'
    }

    const user = userRepository.create(userData)
    const savedUser = await userRepository.save(user)

    expect(savedUser.id).toBeDefined()
    expect(savedUser.username).toBe(userData.username)
    expect(savedUser.createdAt).toBeDefined()
  })

  it('should retrieve user by id', async () => {
    const userData = {
      username: 'testuser',
      name: 'Test User'
    }

    const createdUser = await userRepository.save(userData)
    const retrievedUser = await userRepository.findOne({
      where: { id: createdUser.id }
    })

    expect(retrievedUser).toBeDefined()
    expect(retrievedUser.username).toBe(userData.username)
  })
})
```

### 4.3 组件集成测试

```typescript
// tests/integration/components/UserManagement.spec.ts
import { describe, it, expect, beforeEach } from 'vitest'
import { mount } from '@vue/test-utils'
import { createPinia } from 'pinia'
import UserManagement from '@/views/users/list.vue'

// Mock API
vi.mock('@/api/user', () => ({
  userApi: {
    getList: vi.fn(),
    delete: vi.fn()
  }
}))

describe('UserManagement Integration', () => {
  beforeEach(() => {
    const pinia = createPinia()
    mount(UserManagement, {
      global: {
        plugins: [pinia]
      }
    })
  })

  it('should load and display users', async () => {
    const { userApi } = await import('@/api/user')
    const mockUsers = [
      { id: 1, name: '用户1', email: 'user1@example.com' },
      { id: 2, name: '用户2', email: 'user2@example.com' }
    ]

    vi.mocked(userApi.getList).mockResolvedValue({
      data: mockUsers,
      pagination: { page: 1, size: 20, total: 2 }
    })

    // 验证数据加载和显示
    await nextTick()
    expect(userApi.getList).toHaveBeenCalled()
  })
})
```

---

## 5. 端到端测试策略

### 5.1 E2E测试框架配置

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './tests/e2e',
  timeout: 30 * 1000,
  expect: {
    timeout: 5000
  },
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure'
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] }
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] }
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] }
    }
  ],

  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:5173',
    reuseExistingServer: !process.env.CI
  }
})
```

### 5.2 用户认证流程测试

```typescript
// tests/e2e/auth.spec.ts
import { test, expect } from '@playwright/test'

test.describe('Authentication', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/login')
  })

  test('should login successfully with valid credentials', async ({ page }) => {
    await page.fill('[data-testid="username-input"]', 'admin')
    await page.fill('[data-testid="password-input"]', 'password')
    await page.click('[data-testid="login-button"]')

    // 应该重定向到dashboard
    await expect(page).toHaveURL('/dashboard')

    // 检查用户信息显示
    await expect(page.locator('[data-testid="user-name"]')).toContainText('管理员')
  })

  test('should show error message with invalid credentials', async ({ page }) => {
    await page.fill('[data-testid="username-input"]', 'invalid')
    await page.fill('[data-testid="password-input"]', 'invalid')
    await page.click('[data-testid="login-button"]')

    await expect(page.locator('.el-message--error')).toBeVisible()
    await expect(page.locator('.el-message--error')).toContainText('用户名或密码错误')
  })

  test('should logout successfully', async ({ page }) => {
    // 先登录
    await page.fill('[data-testid="username-input"]', 'admin')
    await page.fill('[data-testid="password-input"]', 'password')
    await page.click('[data-testid="login-button"]')

    await expect(page).toHaveURL('/dashboard')

    // 点击用户下拉菜单
    await page.click('[data-testid="user-dropdown"]')
    await page.click('[data-testid="logout-button"]')

    // 确认退出
    await page.click('.el-message-box__btns .el-button--primary')

    await expect(page).toHaveURL('/login')
  })
})
```

### 5.3 用户管理流程测试

```typescript
// tests/e2e/user-management.spec.ts
import { test, expect } from '@playwright/test'

test.describe('User Management', () => {
  test.beforeEach(async ({ page }) => {
    // 登录
    await page.goto('/login')
    await page.fill('[data-testid="username-input"]', 'admin')
    await page.fill('[data-testid="password-input"]', 'password')
    await page.click('[data-testid="login-button"]')
    await expect(page).toHaveURL('/dashboard')
  })

  test('should create, edit, and delete user', async ({ page }) => {
    // 导航到用户管理页面
    await page.click('text=用户管理')
    await expect(page).toHaveURL('/users')

    // 创建用户
    await page.click('[data-testid="create-user-button"]')
    await page.fill('[data-testid="username-input"]', 'newuser')
    await page.fill('[data-testid="name-input"]', '新用户')
    await page.fill('[data-testid="email-input"]', 'newuser@example.com')
    await page.fill('[data-testid="password-input"]', 'password123')
    await page.click('[data-testid="save-button"]')

    await expect(page.locator('.el-message--success')).toContainText('创建成功')

    // 搜索用户
    await page.fill('[data-testid="search-input"]', 'newuser')
    await page.click('[data-testid="search-button"]')

    // 验证用户在列表中
    await expect(page.locator('table tbody tr')).toContainText('newuser')

    // 编辑用户
    await page.click('text=编辑')
    await page.clear('[data-testid="name-input"]')
    await page.fill('[data-testid="name-input"]', '更新的用户名')
    await page.click('[data-testid="save-button"]')

    await expect(page.locator('.el-message--success')).toContainText('更新成功')

    // 删除用户
    await page.click('text=删除')
    await page.click('.el-message-box__btns .el-button--primary')

    await expect(page.locator('.el-message--success')).toContainText('删除成功')
  })

  test('should search and filter users', async ({ page }) => {
    await page.goto('/users')

    // 搜索用户
    await page.fill('[data-testid="search-input"]', 'admin')
    await page.click('[data-testid="search-button"]')

    await expect(page.locator('table tbody tr')).toContainText('admin')

    // 状态过滤
    await page.click('[data-testid="status-filter"]')
    await page.click('text=启用')

    // 验证过滤结果
    const rows = page.locator('table tbody tr')
    for (let i = 0; i < await rows.count(); i++) {
      await expect(rows.nth(i)).toContainText('启用')
    }
  })
})
```

### 5.4 跨浏览器兼容性测试

```typescript
// tests/e2e/cross-browser.spec.ts
import { test, devices } from '@playwright/test'

const devicesToTest = [
  devices['Desktop Chrome'],
  devices['Desktop Firefox'],
  devices['Desktop Safari'],
  devices['iPad Pro'],
  devices['iPhone 13']
]

for (const device of devicesToTest) {
  test.describe(`Compatibility on ${device.name}`, () => {
    test.use({ ...device })

    test('should display correctly on different devices', async ({ page }) => {
      await page.goto('/login')

      // 检查页面元素是否正确显示
      await expect(page.locator('[data-testid="login-form"]')).toBeVisible()
      await expect(page.locator('[data-testid="username-input"]')).toBeVisible()
      await expect(page.locator('[data-testid="password-input"]')).toBeVisible()
      await expect(page.locator('[data-testid="login-button"]')).toBeVisible()

      // 响应式测试
      if (device.isMobile) {
        await expect(page.locator('.sidebar-container')).toHaveCSS('transform', 'matrix(1, 0, 0, 1, 0, 0)')
      }
    })
  })
}
```

---

## 6. 性能测试策略

### 6.1 前端性能测试

```typescript
// tests/performance/load-time.spec.ts
import { test, expect } from '@playwright/test'

test.describe('Performance Tests', () => {
  test('should load dashboard within performance budget', async ({ page }) => {
    const startTime = Date.now()

    await page.goto('/login')
    await page.fill('[data-testid="username-input"]', 'admin')
    await page.fill('[data-testid="password-input"]', 'password')
    await page.click('[data-testid="login-button"]')
    await page.waitForURL('/dashboard')

    const loadTime = Date.now() - startTime

    // 页面加载时间应该在3秒内
    expect(loadTime).toBeLessThan(3000)
  })

  test('should have good Lighthouse performance score', async ({ page }) => {
    await page.goto('/dashboard')

    const performanceMetrics = await page.evaluate(() => {
      return new Promise((resolve) => {
        const observer = new PerformanceObserver((list) => {
          const entries = list.getEntries()
          const navigation = entries.find(entry => entry.entryType === 'navigation') as PerformanceNavigationTiming
          if (navigation) {
            resolve({
              domContentLoaded: navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart,
              loadComplete: navigation.loadEventEnd - navigation.loadEventStart,
              firstPaint: performance.getEntriesByName('first-paint')[0]?.startTime || 0,
              firstContentfulPaint: performance.getEntriesByName('first-contentful-paint')[0]?.startTime || 0
            })
          }
        })
        observer.observe({ entryTypes: ['navigation'] })
      })
    })

    // 首次内容绘制应该在1.5秒内
    expect(performanceMetrics.firstContentfulPaint).toBeLessThan(1500)
  })
})
```

### 6.2 API性能测试

```typescript
// tests/performance/api.spec.ts
import { describe, it, expect } from 'vitest'
import request from 'supertest'
import app from '@/app'

describe('API Performance', () => {
  it('should respond within 2 seconds', async () => {
    const startTime = Date.now()

    await request(app)
      .get('/api/v1/users')
      .set('Authorization', `Bearer ${process.env.TEST_TOKEN}`)
      .expect(200)

    const responseTime = Date.now() - startTime
    expect(responseTime).toBeLessThan(2000)
  })

  it('should handle concurrent requests', async () => {
    const concurrentRequests = 10
    const promises = Array(concurrentRequests).fill(null).map(() =>
      request(app)
        .get('/api/v1/users')
        .set('Authorization', `Bearer ${process.env.TEST_TOKEN}`)
    )

    const results = await Promise.all(promises)

    results.forEach(response => {
      expect(response.status).toBe(200)
      expect(response.body.code).toBe(0)
    })
  })
})
```

---

## 7. 测试工具和配置

### 7.1 测试工具栈

**单元测试**:
- **Vitest**: 快速的单元测试框架
- **Vue Test Utils**: Vue组件测试工具
- **@testing-library/vue**: 以用户为中心的测试工具

**集成测试**:
- **Supertest**: HTTP接口测试
- **Test Containers**: 数据库测试容器

**E2E测试**:
- **Playwright**: 跨浏览器端到端测试
- **Visual Regression**: 视觉回归测试

**性能测试**:
- **Lighthouse**: 性能评分工具
- **WebPageTest**: 网页性能测试

**代码覆盖率**:
- **c8**: 代码覆盖率工具
- **Istanbul**: JavaScript代码覆盖率

### 7.2 测试配置文件

```json
// package.json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage",
    "test:integration": "vitest --config vitest.integration.config.ts",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:performance": "playwright test --config playwright.performance.config.ts"
  },
  "devDependencies": {
    "@playwright/test": "^1.40.0",
    "@testing-library/vue": "^7.0.0",
    "@vue/test-utils": "^2.4.0",
    "vitest": "^1.0.0",
    "c8": "^8.0.0"
  }
}
```

```typescript
// tests/setup.ts
import { vi } from 'vitest'
import { config } from '@vue/test-utils'

// Mock Element Plus
vi.mock('element-plus', () => ({
  ElMessage: {
    success: vi.fn(),
    error: vi.fn(),
    warning: vi.fn()
  },
  ElMessageBox: {
    confirm: vi.fn().mockResolvedValue('confirm'),
    alert: vi.fn().mockResolvedValue('confirm')
  }
}))

// Global test setup
config.global.plugins = []

// Mock window object
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation(query => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(),
    removeListener: vi.fn(),
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn()
  }))
})
```

---

## 8. 持续集成测试

### 8.1 CI/CD配置

```yaml
# .github/workflows/test.yml
name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run unit tests
      run: npm run test:coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3

  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: test
        ports:
          - 3306:3306

    steps:
    - uses: actions/checkout@v3
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run integration tests
      run: npm run test:integration
      env:
        DATABASE_URL: mysql://root:password@localhost:3306/test

  e2e-tests:
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]

    steps:
    - uses: actions/checkout@v3
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright
      run: npx playwright install --with-deps

    - name: Build application
      run: npm run build

    - name: Run E2E tests
      run: npm run test:e2e

    - uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
```

### 8.2 测试报告

**覆盖率报告**:
- 生成HTML格式覆盖率报告
- 设置覆盖率阈值
- 覆盖率趋势分析

**测试结果报告**:
- 测试执行结果汇总
- 失败测试详细分析
- 测试执行时间统计

**性能测试报告**:
- Lighthouse性能评分
- 关键性能指标监控
- 性能回归检测

---

## 9. 测试数据管理

### 9.1 测试数据策略

**测试数据分类**:
- **基础数据**: 系统必需的基础配置数据
- **业务数据**: 各种业务场景的测试数据
- **边界数据**: 边界条件和异常情况的数据
- **性能数据**: 大数据量性能测试数据

**数据隔离策略**:
- 每个测试用例使用独立的测试数据
- 测试后清理数据，避免相互影响
- 使用事务回滚机制
- Mock和真实数据相结合

### 9.2 数据库测试工具

```typescript
// tests/helpers/database.ts
import { createConnection, getConnection } from 'typeorm'
import { User } from '@/models/User'

export class DatabaseHelper {
  static async setupTestDatabase() {
    const connection = await createConnection({
      type: 'mysql',
      host: 'localhost',
      port: 3306,
      username: 'test',
      password: 'test',
      database: 'test_db',
      synchronize: true,
      dropSchema: true,
      entities: [User]
    })
    return connection
  }

  static async cleanupTestDatabase() {
    const connection = getConnection()
    await connection.close()
  }

  static async createTestUser(userData: Partial<User>) {
    const userRepository = getConnection().getRepository(User)
    const user = userRepository.create(userData)
    return await userRepository.save(user)
  }
}
```

---

## 10. 测试最佳实践

### 10.1 测试编写原则

1. **AAA原则**: Arrange, Act, Assert
2. **单一职责**: 每个测试用例只测试一个功能点
3. **描述性命名**: 测试用例名称应该清楚描述测试内容
4. **独立性**: 测试用例之间不应该有依赖关系
5. **可重复性**: 测试结果应该是可重复的

### 10.2 测试代码质量

1. **代码覆盖率**: 保持高测试覆盖率
2. **测试可维护性**: 测试代码也需要维护和重构
3. **测试速度**: 单元测试应该快速执行
4. **测试稳定性**: 避免不稳定(flaky)的测试

### 10.3 持续改进

1. **定期review**: 定期审查测试用例��测试策略
2. **工具升级**: 跟进测试工具的最新版本
3. **流程优化**: 持续优化测试流程和CI/CD配置
4. **知识分享**: 团队内部测试经验和最佳实践分享

---

## 11. 测试监控和报告

### 11.1 测试监控指标

**质量指标**:
- 代码覆盖率
- 测试通过率
- 缺陷密度
- 测试执行时间

**性能指标**:
- 页面加载时间
- API响应时间
- 并发处理能力
- 资源使用率

### 11.2 自动化报告

**日报**: 每日测试执行结果
**周报**: 测试质量趋势分析
**月报**: 测试覆盖率变化
**发布报告**: 版本发布前的测试报告

---

**注意**: 测试策略需要根据项目实际情况进行调整和优化，确保测试能够有效保证软件质量。