# èŠ‚å‡æ—¥åŒæ­¥é—®é¢˜æœ€ç»ˆä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ€»ç»“

**æŠ¥å‘Šæ—¥æœŸ**: 2025-12-19
**é—®é¢˜çŠ¶æ€**: âœ… å·²ä¿®å¤

### æ ¸å¿ƒé—®é¢˜
ç”¨æˆ·æŠ¥å‘Šçš„ "Invalid time value" é”™è¯¯ï¼Œç»è¿‡æ·±å…¥åˆ†æï¼Œæ ¹æœ¬åŸå› æ˜¯ï¼š

**æ—¥æœŸè§£ææ–¹å¼ä¸å®‰å…¨** - åœ¨ `parseTimorHolidays` å‡½æ•°ä¸­ä½¿ç”¨ `new Date(startDate)` ç›´æ¥è§£æ `YYYY-MM-DD` æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œåœ¨æŸäº›æµè§ˆå™¨ä¸­ä¼šå¯¼è‡´æ—¶åŒºé—®é¢˜æˆ–è§£æå¤±è´¥ã€‚

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜ä»£ç ä½ç½®
**æ–‡ä»¶**: `admin-console/src/utils/timorApi.ts:216`

**åŸä»£ç **:
```typescript
const startDate = holidayData.date

// âŒ é—®é¢˜ï¼šç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²åˆ›å»º Date å¯¹è±¡
const start = new Date(startDate)
const end = new Date(start)
end.setDate(start.getDate() + holidayData.rest - 1)
const endDate = end.toISOString().split('T')[0]
```

### ä¸ºä»€ä¹ˆä¼šå‡ºé”™ï¼Ÿ

1. **æ—¶åŒºé—®é¢˜**: `new Date('2025-01-28')` åœ¨ä¸åŒæµè§ˆå™¨ä¸­å¯èƒ½è¢«è§£æä¸ºï¼š
   - UTC æ—¶é—´ï¼š`2025-01-28T00:00:00Z`
   - æœ¬åœ°æ—¶é—´ï¼š`2025-01-28T00:00:00+08:00`
   - è¿™ä¼šå¯¼è‡´æ—¥æœŸè®¡ç®—é”™è¯¯

2. **æ ¼å¼éªŒè¯ç¼ºå¤±**: å¦‚æœ `startDate` ä¸ºç©ºã€undefined æˆ–æ ¼å¼é”™è¯¯ï¼Œ`new Date()` ä¼šè¿”å› `Invalid Date`ï¼Œè°ƒç”¨ `getDate()` æ—¶æŠ›å‡º "Invalid time value" é”™è¯¯

3. **è¾¹ç•Œæƒ…å†µæœªå¤„ç†**: æ²¡æœ‰éªŒè¯æ—¥æœŸæ˜¯å¦æœ‰æ•ˆï¼Œå¯¼è‡´é”™è¯¯æ•°æ®ç›´æ¥ä¼ é€’åˆ°åç»­é€»è¾‘

---

## ğŸ”§ æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: å®‰å…¨çš„æ—¥æœŸè§£ææ–¹å¼

**ä¿®å¤åä»£ç **:
```typescript
const startDate = holidayData.date

// âœ… éªŒè¯æ—¥æœŸæ ¼å¼
if (!startDate || typeof startDate !== 'string') {
  console.warn('è·³è¿‡æ— æ•ˆçš„èŠ‚å‡æ—¥æ•°æ®ï¼ˆç¼ºå°‘æ—¥æœŸï¼‰:', holidayData)
  continue
}

// âœ… ä½¿ç”¨æ›´å®‰å…¨çš„æ—¥æœŸè§£ææ–¹å¼ï¼Œé¿å…æ—¶åŒºé—®é¢˜
const [yearStr, monthStr, dayStr] = startDate.split('-')
const start = new Date(Number(yearStr), Number(monthStr) - 1, Number(dayStr))

// âœ… éªŒè¯æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
if (isNaN(start.getTime())) {
  console.warn('è·³è¿‡æ— æ•ˆçš„èŠ‚å‡æ—¥æ•°æ®ï¼ˆæ—¥æœŸæ ¼å¼é”™è¯¯ï¼‰:', holidayData)
  continue
}

const end = new Date(start)
end.setDate(start.getDate() + holidayData.rest - 1)

// âœ… æ‰‹åŠ¨æ ¼å¼åŒ–ç»“æŸæ—¥æœŸï¼Œé¿å…æ—¶åŒºé—®é¢˜
const endYear = end.getFullYear()
const endMonth = String(end.getMonth() + 1).padStart(2, '0')
const endDay = String(end.getDate()).padStart(2, '0')
const endDate = `${endYear}-${endMonth}-${endDay}`
```

### ä¿®å¤ä¼˜åŠ¿

1. **æ—¶åŒºå®‰å…¨**: ä½¿ç”¨ `new Date(year, month, day)` æ„é€ å‡½æ•°ï¼Œå§‹ç»ˆåˆ›å»ºæœ¬åœ°æ—¶é—´ï¼Œé¿å…æ—¶åŒºé—®é¢˜
2. **æ ¼å¼éªŒè¯**: æ£€æŸ¥ `startDate` æ˜¯å¦å­˜åœ¨ä¸”ä¸ºå­—ç¬¦ä¸²
3. **æœ‰æ•ˆæ€§éªŒè¯**: ä½¿ç”¨ `isNaN(start.getTime())` æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
4. **é”™è¯¯å®¹é”™**: é‡åˆ°æ— æ•ˆæ•°æ®æ—¶è·³è¿‡å¹¶è®°å½•è­¦å‘Šï¼Œä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
5. **æ ¼å¼ä¸€è‡´**: æ‰‹åŠ¨æ ¼å¼åŒ–æ—¥æœŸï¼Œç¡®ä¿è¾“å‡ºæ ¼å¼ç»Ÿä¸€

---

## ğŸ§ª å¢å¼ºçš„è°ƒè¯•å·¥å…·

### æ–°å¢è¯¦ç»†æ—¥å¿—

**æ–‡ä»¶**: `admin-console/src/utils/debugTimorApi.ts`

**å¢å¼ºçš„ `testCalculateSyncYears` å‡½æ•°**:
```typescript
export function testCalculateSyncYears() {
  console.log('=== æµ‹è¯•å¹´ä»½è®¡ç®— ===')
  const now = new Date()
  console.log('å½“å‰æ—¥æœŸ:', now.toISOString())
  console.log('å½“å‰å¹´ä»½:', now.getFullYear())
  console.log('å½“å‰æ—¶é—´æˆ³:', now.getTime())

  // è®¡ç®—1å¹´å
  const oneYearLater = new Date(now.getTime() + 365 * 24 * 60 * 60 * 1000)
  console.log('1å¹´åæ—¥æœŸ:', oneYearLater.toISOString())
  console.log('1å¹´åå¹´ä»½:', oneYearLater.getFullYear())

  const years = calculateSyncYears()
  console.log('è®¡ç®—çš„å¹´ä»½èŒƒå›´:', years)
  console.log('å¹´ä»½æ•°é‡:', years.length)

  return years
}
```

**å¢å¼ºçš„ `testFetchTimorHolidays` å‡½æ•°**:
```typescript
export async function testFetchTimorHolidays(year: number) {
  console.log(`=== æµ‹è¯•è·å– ${year} å¹´èŠ‚å‡æ—¥æ•°æ® ===`)
  console.log('API URL:', `https://timor.tech/api/holiday/year/${year}`)

  try {
    console.log('å¼€å§‹è°ƒç”¨ API...')
    const data = await fetchTimorHolidays(year, 1)
    console.log('API è°ƒç”¨æˆåŠŸ')
    console.log('API è¿”å›æ•°æ®:', data)
    console.log('è¿”å›çš„èŠ‚å‡æ—¥æ•°é‡:', Object.keys(data.holiday || {}).length)

    console.log('å¼€å§‹è§£æèŠ‚å‡æ—¥æ•°æ®...')
    const holidays = parseTimorHolidays(data, year)
    console.log('è§£ææˆåŠŸ')
    console.log('è§£æåçš„èŠ‚å‡æ—¥:', holidays)
    console.log('æ³•å®šèŠ‚å‡æ—¥æ•°é‡:', holidays.length)

    return { success: true, data, holidays }
  } catch (error) {
    console.error('âŒ API è°ƒç”¨å¤±è´¥')
    console.error('é”™è¯¯ç±»å‹:', error instanceof Error ? error.constructor.name : typeof error)
    console.error('é”™è¯¯æ¶ˆæ¯:', error instanceof Error ? error.message : String(error))
    console.error('å®Œæ•´é”™è¯¯:', error)
    return { success: false, error }
  }
}
```

---

## ğŸ“ æµ‹è¯•æ­¥éª¤

### æ­¥éª¤1: åˆ·æ–°é¡µé¢

**é‡è¦**: å¿…é¡»å¼ºåˆ¶åˆ·æ–°ä»¥åŠ è½½æœ€æ–°ä»£ç 

```bash
# Windows: Ctrl + F5
# Mac: Cmd + Shift + R
```

### æ­¥éª¤2: æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°

æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ° "Console" æ ‡ç­¾é¡µ

### æ­¥éª¤3: è¿è¡Œè°ƒè¯•å‘½ä»¤

#### æµ‹è¯•1: å¹´ä»½è®¡ç®—
```javascript
window.debugTimorApi.testCalculateSyncYears()
```

**é¢„æœŸè¾“å‡º**:
```
=== æµ‹è¯•å¹´ä»½è®¡ç®— ===
å½“å‰æ—¥æœŸ: 2025-12-19T...
å½“å‰å¹´ä»½: 2025
å½“å‰æ—¶é—´æˆ³: 1734...
1å¹´åæ—¥æœŸ: 2026-12-19T...
1å¹´åå¹´ä»½: 2026
è®¡ç®—çš„å¹´ä»½èŒƒå›´: [2025, 2026]
å¹´ä»½æ•°é‡: 2
```

#### æµ‹è¯•2: API è°ƒç”¨
```javascript
await window.debugTimorApi.testFetchTimorHolidays(2025)
```

**é¢„æœŸè¾“å‡º**:
```
=== æµ‹è¯•è·å– 2025 å¹´èŠ‚å‡æ—¥æ•°æ® ===
API URL: https://timor.tech/api/holiday/year/2025
å¼€å§‹è°ƒç”¨ API...
API è°ƒç”¨æˆåŠŸ
API è¿”å›æ•°æ®: {code: 0, holiday: {...}}
è¿”å›çš„èŠ‚å‡æ—¥æ•°é‡: 365
å¼€å§‹è§£æèŠ‚å‡æ—¥æ•°æ®...
è§£ææˆåŠŸ
è§£æåçš„èŠ‚å‡æ—¥: [{name: "å…ƒæ—¦", ...}, {name: "æ˜¥èŠ‚", ...}, ...]
æ³•å®šèŠ‚å‡æ—¥æ•°é‡: 7
```

#### æµ‹è¯•3: å®Œæ•´åŒæ­¥æµç¨‹
```javascript
await window.debugTimorApi.testFullSync()
```

**é¢„æœŸè¾“å‡º**:
```
=== æµ‹è¯•å®Œæ•´åŒæ­¥æµç¨‹ ===
=== æµ‹è¯•å¹´ä»½è®¡ç®— ===
...
=== æµ‹è¯•è·å– 2025 å¹´èŠ‚å‡æ—¥æ•°æ® ===
...
=== æµ‹è¯•è·å– 2026 å¹´èŠ‚å‡æ—¥æ•°æ® ===
...
=== åŒæ­¥æµ‹è¯•å®Œæˆ ===
ç»“æœæ±‡æ€»: [{year: 2025, success: true, ...}, {year: 2026, success: true, ...}]
```

### æ­¥éª¤4: æµ‹è¯•æ‰‹åŠ¨åŒæ­¥

1. ç‚¹å‡» **"ç«‹å³åŒæ­¥"** æŒ‰é’®
2. ç¡®è®¤å¯¹è¯æ¡†ä¸­ç‚¹å‡» **"ç¡®å®š"**
3. è§‚å¯Ÿè¿›åº¦æ¡å’Œè¿›åº¦æ¶ˆæ¯
4. ç­‰å¾…åŒæ­¥å®Œæˆ

**é¢„æœŸç»“æœ**:
- âœ… ä¸å†å‡ºç° "Invalid time value" é”™è¯¯
- âœ… è¿›åº¦æ¡æ­£å¸¸æ˜¾ç¤º
- âœ… åŒæ­¥å®Œæˆåæ˜¾ç¤ºç»“æœå¯¹è¯æ¡†
- âœ… èŠ‚å‡æ—¥åˆ—è¡¨åŒ…å« 2025 å’Œ 2026 å¹´æ•°æ®

---

## ğŸ”„ ä¿®å¤å†å²

### ä¿®å¤1: AbortSignal.timeout() å…¼å®¹æ€§ âœ…
**é—®é¢˜**: æµè§ˆå™¨ä¸æ”¯æŒ `AbortSignal.timeout()`
**ä¿®å¤**: ä½¿ç”¨ `AbortController` + `setTimeout`
**çŠ¶æ€**: å·²ä¿®å¤

### ä¿®å¤2: toLocaleString() æ ¼å¼ä¸ä¸€è‡´ âœ…
**é—®é¢˜**: ä¸åŒæµè§ˆå™¨è¿”å›æ ¼å¼ä¸åŒ
**ä¿®å¤**: æ‰‹åŠ¨æ ¼å¼åŒ–æ—¶é—´å­—ç¬¦ä¸²
**çŠ¶æ€**: å·²ä¿®å¤

### ä¿®å¤3: å¹´ä»½è®¡ç®—é€»è¾‘é”™è¯¯ âœ…
**é—®é¢˜**: `setFullYear(currentYear + 1)` è®¡ç®—é”™è¯¯
**ä¿®å¤**: ä½¿ç”¨ `getTime() + 365å¤©` æ­£ç¡®è®¡ç®—
**çŠ¶æ€**: å·²ä¿®å¤

### ä¿®å¤4: æ—¥æœŸè§£æä¸å®‰å…¨ âœ… (æœ¬æ¬¡ä¿®å¤)
**é—®é¢˜**: `new Date(startDate)` å¯¼è‡´æ—¶åŒºé—®é¢˜å’Œ "Invalid time value" é”™è¯¯
**ä¿®å¤**: ä½¿ç”¨ `new Date(year, month, day)` å®‰å…¨è§£æï¼Œå¢åŠ éªŒè¯
**çŠ¶æ€**: å·²ä¿®å¤

---

## ğŸ“Š ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ |
|------|---------|------|
| `timorApi.ts:57-69` | ä¿®å¤ API è¶…æ—¶æ§åˆ¶ | âœ… å·²ä¿®å¤ |
| `timorApi.ts:167-182` | ä¿®å¤å¹´ä»½è®¡ç®—é€»è¾‘ | âœ… å·²ä¿®å¤ |
| `timorApi.ts:200-252` | **ä¿®å¤æ—¥æœŸè§£ææ–¹å¼ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰** | âœ… å·²ä¿®å¤ |
| `holidaySyncService.ts:385-394` | ä¿®å¤æ—¶é—´æ ¼å¼åŒ– | âœ… å·²ä¿®å¤ |
| `debugTimorApi.ts:11-28` | å¢å¼ºå¹´ä»½è®¡ç®—è°ƒè¯• | âœ… å·²æ·»åŠ  |
| `debugTimorApi.ts:33-58` | å¢å¼º API è°ƒç”¨è°ƒè¯• | âœ… å·²æ·»åŠ  |

---

## âœ… éªŒæ”¶æ ‡å‡†

- [x] ä¿®å¤ `AbortSignal.timeout()` å…¼å®¹æ€§é—®é¢˜
- [x] ä¿®å¤ `toLocaleString()` æ ¼å¼ä¸ä¸€è‡´é—®é¢˜
- [x] ä¿®å¤å¹´ä»½è®¡ç®—é€»è¾‘é”™è¯¯
- [x] **ä¿®å¤æ—¥æœŸè§£æå¯¼è‡´çš„ "Invalid time value" é”™è¯¯**
- [x] å¢å¼ºè°ƒè¯•å·¥å…·ï¼Œæ·»åŠ è¯¦ç»†æ—¥å¿—
- [x] ESLint æ£€æŸ¥é€šè¿‡
- [x] ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
- [ ] åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼ˆå¾…ç”¨æˆ·æµ‹è¯•ï¼‰
- [ ] æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•é€šè¿‡ï¼ˆå¾…ç”¨æˆ·æµ‹è¯•ï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

1. **å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨é¡µé¢**ï¼ˆCtrl + F5ï¼‰
2. **æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°**ï¼ˆF12ï¼‰
3. **è¿è¡Œè°ƒè¯•å‘½ä»¤æµ‹è¯•**
   ```javascript
   window.debugTimorApi.testCalculateSyncYears()
   await window.debugTimorApi.testFetchTimorHolidays(2025)
   await window.debugTimorApi.testFullSync()
   ```
4. **å°è¯•æ‰‹åŠ¨åŒæ­¥**
5. **åé¦ˆæµ‹è¯•ç»“æœ**

---

## ğŸ“ å¦‚æœä»ç„¶å¤±è´¥

è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **æµè§ˆå™¨ä¿¡æ¯**
   - æµè§ˆå™¨ç±»å‹å’Œç‰ˆæœ¬
   - æ“ä½œç³»ç»Ÿç‰ˆæœ¬

2. **æ§åˆ¶å°è¾“å‡º**
   - è¿è¡Œ `window.debugTimorApi.testCalculateSyncYears()` çš„å®Œæ•´è¾“å‡º
   - è¿è¡Œ `await window.debugTimorApi.testFullSync()` çš„å®Œæ•´è¾“å‡º
   - ä»»ä½•çº¢è‰²é”™è¯¯ä¿¡æ¯

3. **ç½‘ç»œè¯·æ±‚**
   - æ‰“å¼€å¼€å‘è€…å·¥å…· â†’ Network æ ‡ç­¾é¡µ
   - æŸ¥æ‰¾ `timor.tech` çš„è¯·æ±‚
   - æŸ¥çœ‹è¯·æ±‚çŠ¶æ€å’Œå“åº”å†…å®¹

---

**ä¿®å¤äºº**: Claude Code
**ä¿®å¤æ—¥æœŸ**: 2025-12-19
**ç‰ˆæœ¬**: v1.0.3
**æ ¸å¿ƒä¿®å¤**: æ—¥æœŸè§£ææ–¹å¼ä»å­—ç¬¦ä¸²ç›´æ¥è§£ææ”¹ä¸ºå®‰å…¨çš„æ„é€ å‡½æ•°æ–¹å¼
